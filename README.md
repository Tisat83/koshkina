# Мой дом на Кошкина — сайт сообщества соседей

Небольшой закрытый сайт для жильцов дома на улице Кошкина.

## Назначение

- Перенести часть общения соседей с WhatsApp в более устойчивые каналы (Telegram, мессенджер MAX).
- Дублировать важные объявления и новости по дому (ремонты, отключения, собрания и т.п.).
- Публиковать важные новости района, которые не всегда удобно размещать в чатах.
- Организовать удобную **интерактивную парковку** во дворе.

Сайт **не является публичным**: доступ к новостям, профилю и парковке есть только у авторизованных жильцов.

---

## Технологии

- **Python 3**
- **Flask** — веб-фреймворк
- HTML + CSS (минималистичный адаптивный интерфейс)
- Данные в формате JSON:
  - `data/users.json` — жильцы, профили, PIN-коды
  - `data/posts.json` — новости дома и района
  - `data/parking.json` — конфигурация парковочных мест
  - `data/parking_state.json` — текущее состояние занятости парковки
  - `data/subscriptions.json` — настройки подписок на категории новостей
  - `data/info.json` — блоки «полезной информации» для сайдбара
  - `data/invites.json` — приглашения на регистрацию
  - `data/reactions.json` — реакции на новости
  - (опционально) Telegram-бот для уведомлений по парковке и рассылок:
  - `notifications.py` — функции отправки сообщений в Telegram;
  - используется токен бота из переменной окружения `TELEGRAM_BOT_TOKEN`.
  - `data/guests.json` — гостевые заявки и профили гостей парковки
  - загружаемые фото гостей: `static/uploads/guests/` (файлы изображений)


---

## Структура проекта

```text
koshkina/
├── app.py                # Основное приложение Flask (маршруты, логика, API парковки)
├── notifications.py      # Уведомления в Telegram (парковка, тестовый эндпоинт)
├── requirements.txt      # Зависимости Python
├── README.md             # Описание проекта
├── .gitignore            # Исключения для Git
├── data
│   ├── users.json        # Жильцы, профили, PIN-коды, флаги is_admin
│   ├── posts.json        # Новости дома и района
│   ├── parking.json      # Конфигурация парковки (список мест)
│   ├── parking_state.json# Текущее состояние занятости мест
│   ├── subscriptions.json# Подписки на категории новостей
│   ├── info.json         # Блоки полезной информации (для сайдбара)
│   ├── invites.json      # Пригласительные ссылки на регистрацию
│   └── reactions.json    # Реакции (эмодзи) на новости
│   ├── guests.json       # Гостевые заявки и одобренные гости парковки
├── templates             # HTML-шаблоны (Jinja2)
│   ├── base.html         # Базовый макет сайта, шапка/футер
│   ├── index.html        # Публичная главная страница
│   ├── login.html        # Страница входа
│   ├── news.html         # Лента новостей (жильцы)
│   ├── profile.html      # Профиль жильца (ФИО, телефоны, авто, смена PIN)
│   ├── parking.html      # Интерактивная парковка
│   ├── admin_news_new.html  # Создание/редактирование новостей (админ)
│   ├── admin_invites.html   # Управление пригласительными ссылками (админ)
│   ├── register.html        # Регистрация по приглашению
│   ├── forgot_pin.html      # Информация по восстановлению PIN
│   └── info.html            # Отдельная страница с полезной информацией
│   ├── parking_guest.html    # Гостевая страница парковки (QR-ссылка)
│   ├── admin_guests.html     # Список гостевых заявок (админ)

└── static
    ├── css
    │   └── style.css     # Стили сайта
    ├── js
    │   ├── theme.js      # Тёмная/светлая тема (если включено)
    │   └── lightbox.js   # Лайтбокс для галереи
    └── img               # Изображения (иллюстрации, парковка)
        ├── telegram_welcome.png
        ├── max_welcome.png
        ├── parking_top.png             # Схема верхней части двора
        ├── parking_bottom.png (опц.)   # Нижняя часть двора (если используется)
        ├── parking_slot_regular.png    # Слот обычного места
        ├── parking_slot_blocking.png   # Слот перекрывающего места
        ├── parking_car_regular.png     # Машинка для обычного места
        ├── parking_car_blocking.png    # Машинка для перекрывающего места
        ├── parking_sign_nopark.png     # Знак «не паркуемся»
        └── parking_sign_warning.png    # Знак «внимательно паркуемся»
    │   └── guest_photos/               # Фото машин гостей (загруженные файлы)

---

## Функциональность
Публичная часть
- / — главная страница:
 -- краткое описание проекта;
 -- блоки «полезной информации»;
 -- ссылки/кнопки на Telegram-канал и сообщество MAX:
  --- визуально кнопки могут быть видны всем,
  --- реальные ссылки/URL доступны только авторизованным;
 -- кнопка «Вход для жильцов».
Любой посетитель может видеть главную страницу и публичные объявления, отмеченные как «показывать на главной».

---

## Авторизация и регистрация
- /login — вход:
 -- логин: номер квартиры;
 -- ключ: PIN-код (4–8 цифр).
- PIN хранится в users.json в хэшированном виде (Werkzeug), поддерживается несколько жильцов в одной квартире (residents).
- Для совместимости:
 -- возможно временное использование телефона как «пароля», если PIN ещё не задан или включён аварийный аварийный режим (ALLOW_PHONE_FALLBACK).
- Администраторы задаются:
 -- через список квартир в переменной окружения ADMIN_APARTMENTS (например, 501,12);
 -- и/или флагом is_admin в users.json.
 В `data/users.json` также хранятся флаги и сервисные поля:
- `can_use_parking` — доступ к странице парковки и бронированию мест;
- `can_subscribe_parking` — возможность подписываться на уведомления по местам;
- `telegram_chat_id` — идентификатор чата пользователя в Telegram для отправки уведомлений.

Регистрация:
- /register/<token> — регистрация по приглашению:
 -- админ создаёт пригласительную ссылку для квартиры (страница /admin/invites);
 -- жильцы по ссылке сами задают имя, телефон и PIN;
 -- поддерживаются несколько резидентов для одной квартиры.
Безопасность:
- Все чувствительные файлы (data/users.json, data/*) должны быть в .gitignore.
- PIN-коды хэшируются, секретный ключ Flask рекомендуется выносить в переменные окружения.
- Аварийный вход по телефону может быть включен только временно для восстановления.

---

## Профиль жильца
- /profile — личный кабинет:
 -- Фамилия, имя, отчество;
 -- Квартира (для отображения, логин не меняется);
 -- Телефон основной;
 -- Телефон дополнительный;
 -- Номер машины (например, А777ЕТ197; поле видно только если для квартиры включён доступ к парковке);
 Данные профиля используются, в том числе, для автозаполнения формы бронирования парковочного места (телефон и номер авто можно подправить на конкретную поездку).
 -- Смена PIN-кода с проверкой текущего:
  --- текущий PIN (если уже задан);
  --- новый PIN (два поля, проверка совпадения и длины 4–8 цифр).
Данные профиля используются, в том числе, для автозаполнения формы бронирования парковочного места (телефон и номер авто можно подправить на конкретную поездку).

---

## Новости
- /news — лента новостей (только для авторизованных):
 -- объявления по дому и новости района;
 -- категория: «Дом» / «Район» (можно расширять);
 -- источник: Telegram / MAX / только сайт;
 -- настройки подписки по категориям (хранится в subscriptions.json);
 -- реакции на новости (набор эмодзи) с хранением в reactions.json;
 -- пагинация (POSTS_PER_PAGE задаётся в app.py);
 -- боковой блок «полезная информация» на основе data/info.json.
- /news/archive — архив новостей
Отдельный режим отображения для архивных новостей (is_archived).
- Админ-функции:
 -- /admin/news/new — создание новости;
 -- /admin/news/<id>/edit — редактирование;
 -- /admin/news/<id>/delete — удаление;
 -- превью и галерея изображений:
  --- загрузка файлов;
  --- подхват по URL (сохранение в static/img/news).

---

## Интерактивная парковка
- /parking — закрытая страница:
  - доступна только авторизованным жильцам;
  - дополнительно проверяется флаг `can_use_parking` в `users.json`
    (если он `false` и пользователь не админ — страница недоступна).
- Конфигурация мест хранится в `data/parking.json`:
  - список мест с ID, подписью и типом (обычное, перекрывающее и т.п.).
- Текущее состояние мест хранится в `data/parking_state.json`:
  - кто занял, до какого времени, статус «надолго»;
  - отдельный блок `subscriptions` — список подписчиков на освобождение мест;
  - при каждом запросе просроченные брони автоматически очищаются, а подписчикам отправляются уведомления.

Фронтенд-логика:

- Карта двора — фон `parking_top.png` + интерактивные слоты:
  - места 1–8 — обычные (в ряд), места 9–12 — перекрывающие;
  - каждый слот имеет номер и состояние (свободно / занято до … / надолго);
  - при занятии места поверх слота появляется «машинка» соответствующего типа.
- При выборе места:
  - автозаполняются телефон и номер машины из профиля (если доступны);
  - можно указать время «занято до …» (обязательное поле);
  - можно включить/выключить показ телефона для других жильцов.
- Ограничения и права:
  - один пользователь может держать занятым только одно место;
  - по наступлении времени окончания место автоматически освобождается;
  - админ может принудительно освободить любое место и отметить «надолго» для брошенной машины
    (при этом квартира админа в карточке такого места не отображается).
- Уведомления и подписки:
  - если у пользователя в профиле задан `telegram_chat_id` и включён флаг `can_subscribe_parking`,
    он может подписаться на уведомление «когда это место освободится»;
  - уведомление отправляется через Telegram-бота:
    - либо при автоматическом освобождении по времени;
    - либо при ручном освобождении места владельцем или админом;
  - подписки хранятся по каждому месту в `parking_state.json`.
- Мобильная версия:
  - специальная кнопка разворачивает карту парковки поверх страницы;
  - при этом увеличивается масштаб центральной части, карту можно двигать пальцем.
  
### Гостевая парковка

- `/p/guest` — гостевая страница парковки:
  - доступна без авторизации (обычно по QR-коду под лобовым стеклом);
  - показывает схему двора (`parking_top_guest.png`) и краткое объяснение правил.

- На странице есть две формы:
  - быстрый переход к регистрации через Telegram-бота;
  - подробная форма заявки через сайт.

- Форма заявки через сайт:
  - поля: имя, телефон, номер машины, место на схеме (1–12), время «до какого момента планируете стоять», комментарий;
  - список мест строится на основе актуального состояния парковки — занятые места автоматически отключены и выбрать их нельзя;
  - можно прикрепить фото машины; файл сохраняется в `static/img/guest_photos/`.

- После отправки:
  - заявка сохраняется в `data/guests.json` со статусом `pending`;
  - администратору уходит уведомление в Telegram через `notifications.py` с данными гостя и номером места.

- Админ-интерфейс:
  - `/admin/guests` — таблица заявок:
    - статус (ожидает / одобрена / отклонена),
    - имя, телефон, номер машины,
    - выбранное место,
    - миниатюра фото (при клике открывается полноразмерное изображение),
    - комментарий и время создания;
  - админ может «Одобрить», «Отклонить» или «Удалить» заявку.

- При одобрении заявки:
  - гость занимает указанное место в `parking_state.json` как обычный владелец;
  - в карточке места на странице `/parking` в блоке «Текущий владелец» показывается:
    - текст вида: `Гость Имя, авто ХХХ, тел. 8…`;
    - миниатюра фото машины (если есть), по клику открывается полноразмерное фото;
  - гость автоматически добавляется в `users.json` как отдельный профиль: (пока не разработано)
    - логином выступает телефон, (пока не разработано)
    - PIN — упрощённый (например, три цифры из номера машины), (пока не разработано)
    - роль помечена как «гость», чтобы отличать от жильцов. 

- Ограничения:
  - гость не может миновать ручное одобрение администратором при первой заявке;
  - в дальнейшем одобренный гость может бронировать места так же, как жильцы, но с ограничениями, которые можно задать в `users.json`.

---

### Примеры структуры файлов парковки

#### data/parking.json

Файл с конфигурацией мест. Обычно правится вручную очень редко.

```json
{
  "spots": [
    {
      "id": 1,
      "label": "Место 1",
      "type": "regular",
      "description": "Обычное место перед домом"
    },
    {
      "id": 2,
      "label": "Место 2",
      "type": "regular"
    },
    {
      "id": 9,
      "label": "Место 9 (перекрывающее)",
      "type": "blocking",
      "description": "Можно перекрывать другие машины, владелец оставляет телефон"
    }
  ]
}

Основные поля:
- id — числовой идентификатор места (1–12, как на схеме);
- label — подпись для человека («Место 1», «Перед подъездом» и т.п.);
- type — тип места (regular, blocking и т.п. — используется для оформления);
- description — необязательный текст для подсказок.

data/parking_state.json
Файл с текущим состоянием мест и подписками. Создаётся и изменяется автоматически.

{
  "spots": {
    "1": {
      "apartment": "501",
      "name": "Александр",
      "car_code": "С070ЕТ197",
      "phone": "+7 926 999-99-99",
      "show_phone": true,
      "until": "2025-12-11T21:30",
      "long_term": false,
      "updated_at": "2025-12-11T18:57",
      "telegram_chat_id": "123456789"
    },
    "9": {
      "apartment": "",
      "name": "Брошенная машина",
      "car_code": "Х000ХХ000",
      "phone": "",
      "show_phone": false,
      "until": "2025-12-20T12:00",
      "long_term": true,
      "updated_at": "2025-12-11T10:15",
      "telegram_chat_id": ""
    }
  },
  "subscriptions": {
    "1": [
      "123456789",
      "987654321"
    ],
    "9": [
      "123456789"
    ]
  }
}

Основные поля:

- spots — словарь занятых мест:
 -- ключ — строковый ID места ("1", "9" и т.п.);
 -- значение — информация о текущей броне:
 --- apartment — квартира, которая заняла место (может быть пустой, если админ поставил «надолго» для брошенной машины);
 --- name — имя/подпись (может совпадать с профилем или быть произвольным текстом админа);
 --- car_code — номер машины (может отличаться от номера из профиля);
 --- phone — телефон для связи (если show_phone = true);
 --- show_phone — показывать ли телефон другим жильцам;
 --- until — время «занято до …» в формате YYYY-MM-DDTHH:MM;
 --- long_term — флаг «надолго» (ставит только админ);
 --- updated_at — время последнего изменения записи;
 --- telegram_chat_id — идентификатор чата владельца в Telegram для уведомлений.
- subscriptions — подписки на освобождение мест:
 -- ключ — ID места строкой;
 -- значение — список telegram_chat_id, которые ждут уведомление, когда это место освободится.

Важно: parking_state.json редактируется только приложением. Вручную его имеет смысл трогать только для отладки или «обнуления» всех мест (например, поставить "spots": {} и "subscriptions": {}).

---

## Полезная информация и ссылки
- Блоки «полезной информации» задаются в data/info.json и могут выводиться:
  - на главной;
  - в новостях;
  - на отдельной странице /info.
- В каждой записи можно указать, где именно она должна отображаться (через поле show_on и аналоги).

---

## Настройки и переменные окружения
- ADMIN_APARTMENTS — список квартир-админов (например: 501,12).
- TELEGRAM_BOT_TOKEN — токен Telegram-бота для отправки уведомлений:
  - если не задан, функциональность уведомлений по парковке будет выключена;
  - для проверки связи есть эндпоинт `/api/debug/telegram` (доступен только админам).
  
  ### Привязка Telegram к пользователю

Чтобы жильцу приходили уведомления по парковке:

1. Пользователь должен написать что-нибудь в Telegram-бот (чтобы бот мог отправлять ему сообщения).
2. Администратор узнаёт его `chat_id` и записывает его в `data/users.json` в поле `telegram_chat_id`.

Простейший способ узнать `chat_id`:

- временно использовать любой внешний сервис / бот-инструмент (например, @userinfobot), либо
- сделать небольшой вспомогательный бот, который при любом входящем сообщении логирует `chat_id` в консоль.

После того как `chat_id` известен, в `data/users.json` для нужной квартиры можно прописать, например:

```json
"501": {
  "first_name": "Александр",
  "phones": ["+7 926 999-99-99"],
  "car_code": "С070ЕТ197",
  "can_use_parking": true,
  "can_subscribe_parking": true,
  "telegram_chat_id": "123456789"
}

Проверка связи с Telegram-ботом (для админа)

Для быстрого теста есть эндпоинт:

- GET /api/debug/telegram?chat_id=XXX&text=Привет

Доступен только авторизованным администраторам.

Пример запроса из браузера (после входа на сайт под админом):
http://127.0.0.1:5000/api/debug/telegram?chat_id=123456789&text=Тест+с+парковки

Если всё настроено правильно:
- в ответ придёт JSON { "ok": true },
- в Telegram у пользователя с таким chat_id появится сообщение от бота.

- ALLOW_PHONE_FALLBACK — включает аварийный вход по телефону, если PIN уже задан:
 -- 1, true, yes, on — включить;
 -- по умолчанию выключено.
- Рекомендуется также вынести app.secret_key в переменную окружения (или .env).

---

## Локальный запуск

1. Установить Python 3.

2. Клонировать репозиторий или создать структуру проекта:
cd /path/to/koshkina


3. Создать и активировать виртуальное окружение:
python -m venv .venv
# Windows:
.venv\Scripts\activate
# Linux / macOS:
source .venv/bin/activate

4. Установить зависимости:
pip install -r requirements.txt

5. Заполнить файлы в data/ (минимум users.json, posts.json, parking.json).
- Простейшие варианты можно взять из примеров или собрать вручную.

6. (Опционально) выставить переменные окружения:
set ADMIN_APARTMENTS=501
set ALLOW_PHONE_FALLBACK=0

7. Запустить приложение:
python app.py

8. Открыть в браузере:
- Публичная главная: http://127.0.0.1:5000/
- Лента новостей (после входа): http://127.0.0.1:5000/news
- Профиль: http://127.0.0.1:5000/profile
- Парковка: http://127.0.0.1:5000/parking

---

## Дальнейшие планы

- Уведомления:
  - расширить типы уведомлений по парковке (например, «бронь закончится через 15 минут»);
  - добавить массовые рассылки важных объявлений через Telegram-бота.

- Режим гостей:
  - упростить повторные бронирования для уже одобренных гостей (меньше ручной работы для админа);
  - добавить полноценный сценарий регистрации и бронирования через Telegram-бота (без формы на сайте).

- Роли и права:
  - ввести роли «старший по подъезду», «ответственный за парковку» с ограниченным набором админ-действий;
  - гибкая настройка прав на управление местами и новостями.

- Улучшение мобильного UX:
  - быстрые действия «я уехал» / «я вернулся» для своих мест;
  - отображение фото машины владельца прямо на схеме (опционально).
  
- Общая страница Админа:
  - Все ссылки вывести на отдельной странице админа    
