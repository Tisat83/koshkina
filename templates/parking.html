{% extends "base.html" %}

{% block title %}Парковка{% endblock %}
{% block head_extra %}
<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/parking-180.png') }}?v=1">
<link rel="apple-touch-icon" sizes="167x167" href="{{ url_for('static', filename='icons/parking-167.png') }}?v=1">
<link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='icons/parking-152.png') }}?v=1">
<link rel="apple-touch-icon" sizes="120x120" href="{{ url_for('static', filename='icons/parking-120.png') }}?v=1">
<link rel="apple-touch-icon" sizes="76x76"  href="{{ url_for('static', filename='icons/parking-76.png') }}?v=1">

<meta name="apple-mobile-web-app-title" content="Парковка">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
{% endblock %}


{% block content %}
<section
    class="info-section parking-section"
    id="parking-root"
    data-user-apartment="{{ user.get('apartment', '') }}"
    data-user-is-admin="{{ '1' if user.get('is_admin') else '0' }}"
    data-user-phone="{{ user.get('phone', '') }}"
    data-user-car-number="{{ user.get('car_code') or user.get('car_number', '') }}"
    data-user-can-subscribe="1"
	data-user-is-guest="{{ '1' if user.get('is_guest') else '0' }}"
    data-user-guest-status="{{ user.get('guest_status', '') }}"

>
<div id="guestPendingOverlay" class="guest-pending-overlay" aria-hidden="true">
  <div class="guest-pending-card">
    <h2 class="guest-pending-title">Заявка на парковку отправлена</h2>
    <p class="guest-pending-text">
      Администратор проверит вашу заявку. Пока заявка не одобрена, парковка будет недоступна.
    </p>
    <p class="guest-pending-text">
      Как только заявка будет одобрена — это окно исчезнет автоматически.
    </p>
<div class="guest-pending-status-row">
  <div class="guest-pending-status" id="guestPendingStatus">В ожидании одобрения…</div>

  <button
    type="button"
    class="parking-btn parking-btn-primary"
    id="guestPendingCheckBtn"
  >
    Проверить статус
  </button>
</div>

<div class="guest-pending-rejected" id="guestPendingRejected" style="display:none;">
  <h3 style="margin: 12px 0 6px 0;">Заявка отклонена</h3>
  <p style="margin: 0; opacity: .92;">
    Причины могут быть разные, но основная — вашу машину не обнаружили на выбранном вами месте.
    Подайте заявку ещё раз и убедитесь, что вы указали верное место и номер машины.
  </p>
</div>

  </div>
</div>

    <h1>Парковка в нашем дворе</h1>


	    <!-- Мобильный режим: только схема -->
    <div class="parking-mobile-toolbar">
        <button
            type="button"
            id="parkingCompactToggle"
            class="parking-btn parking-btn-secondary parking-compact-toggle"
            aria-pressed="false"
        >
            Только схема
        </button>
    </div>

    <style>
        .parking-layout {
            margin-top: 12px; /* только отступ, без flex */
        }
		        /* --- Мобильный режим "Только схема" --- */
        .parking-mobile-toolbar {
            display: none;
            margin: 10px 0 6px;
            justify-content: flex-end;
        }

        @media (max-width: 768px) {
            .parking-mobile-toolbar {
                display: flex;
            }
        }
		        /* --- Справка/инструкция --- */
        .parking-help {
            margin: 8px 0 10px;
            border: 1px solid rgba(0,0,0,.08);
            border-radius: 12px;
            padding: 8px 10px;
            background: rgba(0,0,0,.02);
        }

        .parking-help-summary {
            cursor: pointer;
            font-weight: 700;
            list-style: none;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
        }

        .parking-help-summary::-webkit-details-marker {
            display: none;
        }

        .parking-help-hint {
            font-weight: 400;
            opacity: 0.75;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .parking-help-body {
            margin-top: 8px;
        }

        /* На телефоне по умолчанию свернуто, на ПК можно оставить открытым через JS ниже */
        @media (max-width: 768px) {
            .parking-help-hint {
                display: none;
            }
        }

        /* когда включён режим "Только схема" */
        #parking-root.parking-compact .auth-description,
		#parking-root.parking-compact .parking-help,
        #parking-root.parking-compact .parking-spots,
        #parking-root.parking-compact figure.parking-figure:not(.parking-figure-top) {
            display: none !important;
        }


        .parking-figure {
            margin: 0;
        }

        .parking-figure figcaption {
            font-size: 14px;
            margin-bottom: 6px;
            color: var(--muted-text);
        }

        .parking-figure > img {
            display: block;
            width: 100%;
            max-width: 100%;
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
        }

        .parking-figure-top .parking-image-wrapper {
            position: relative;
        }

        .parking-map-bg {
            display: block;
            width: 100%;
            max-width: 100%;
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
        }
		/* --- Упрощённый режим: фокус на зоне мест 1–12 --- */
.parking-map-inner {
    position: relative;
}

/* В "Упростить" делаем карту "окном" */
#parking-root.parking-compact .parking-image-wrapper {
    overflow: hidden;
}

/* Сдвигаем и увеличиваем содержимое, чтобы показать только нужный кусок карты */
#parking-root.parking-compact .parking-map-inner {
    transform-origin: top left;
    transform: scale(1.55) translate(-18%, -10%);
}

/* В упрощённом режиме прячем Zoom, чтобы не было двойного зума */
#parking-root.parking-compact #parkingFullscreenToggle {
    display: none !important;
}


/* Картинка ПАРКОВОЧНОГО МЕСТА (P) — всегда видна */
.parking-hotspot-img {
    display: block;
    width: 100%;
    height: auto;
    border-radius: 12px;
    box-shadow: none;   /* 0 0 0 1px rgba(15, 23, 42, 0.07) убрали тень */
    transition:
        box-shadow 0.12s ease,
        opacity 0.12s ease;
}

/* Машинка меньше слота и по центру */
.parking-hotspot-car {
    position: absolute;
    left: 50%;
    top: 200%;                                /* чуть ниже центра, можно подправить */
    transform: translate(-50%, -50%);
    width: 80% !important;                   /* ВОТ ЗДЕСЬ регулируется размер машинки */
    height: auto;
    border-radius: 999px;
    box-shadow: none;
    display: none !important;
    pointer-events: none;
}

/* если занято / надолго — показываем машинку */
.parking-hotspot--occupied .parking-hotspot-car,
.parking-hotspot--long-term .parking-hotspot-car {
    display: block !important;
}


/* Номер машинки поверх */
.parking-hotspot-label {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 600;
    /* тёмный текст, чтобы читался на светлой машине */
    color: #111827;
    text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
    pointer-events: none;
    /* для 1–8 — чуть ниже центра, ближе к окну */
    transform: translateY(9px);
}

/* общее наведение — мягкая синяя подсветка, без поворота */
/* Подсветка слота только для свободных мест */
.parking-hotspot:not(.parking-hotspot--occupied):not(.parking-hotspot--long-term):hover
.parking-hotspot-img {
    box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.7);
}

/* Значки-подсказки на схеме */
.parking-marker {
    position: absolute;
    border: none;
    padding: 0;
    background: transparent;
    width: 32px;
    height: 32px;
    transform: translate(-50%, -50%);
    cursor: pointer;
    z-index: 5;

    /* убираем «круглую кнопку» из базовых стилей */
    border-radius: 0;
    box-shadow: none;
}

.parking-marker:focus {
    outline: none;
}

.parking-marker-img {
    display: block;
    width: 100%;
    height: auto;
    border-radius: 0 !important;
    box-shadow: none !important;
    background: transparent;
}

/* чтобы машинки были поверх значков */
.parking-hotspot {
    position: absolute;
    border: none;
    padding: 0;
    background: transparent;
    width: 65px; /* твои актуальные значения */
    height: 30px;
    transform: translate(-50%, -50%);
    cursor: pointer;
    z-index: 10;
}

.parking-hotspot--blocking {
    width: 90px;
    height: 30px;
}

/* --- Увеличение "зоны тапа" на телефонах (без изменения внешнего вида) --- */
@media (max-width: 768px) {
    .parking-hotspot,
    .parking-marker {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }

    /* Умеренный хитбокс для мест 1–8 (они близко друг к другу) */
    .parking-hotspot::before {
        content: "";
        position: absolute;
        inset: -5px;   /* было бы -8, но для 2–8 это уже мешает */
    }

    /* Для перекрывающих 9–12 — чуть больше, потому что они сложнее */
    .parking-hotspot.parking-hotspot--blocking::before {
        inset: -8px;
    }

    /* Маркеры/значки на схеме — чуть больше, чтобы легче попадать */
    .parking-marker::before {
        content: "";
        position: absolute;
        inset: -6px;
    }
}


/* Перекрывающие 9–12: поворачиваем МАШИНУ, не слот */
.parking-hotspot--blocking .parking-hotspot-car {
	top: 86%;
    width: 56% !important;   /* поменьше, подгони по вкусу */
    transform: translate(-50%, -50%) rotate(-90deg) !important;
}

/* Наведение: поворот сохраняем, подсветка остаётся на слоте через общее правило hover */
.parking-hotspot--blocking:hover .parking-hotspot-car {
    transform: rotate(-90deg);
}


/* Цифры на перекрывающих — смещаем ближе к "заднему" стеклу */
.parking-hotspot--blocking .parking-hotspot-label {
    transform: translate(-35px, 10px);
}


        .parking-spots {
            margin-top: 24px;
            background: var(--card-bg);
            border-radius: 14px;
            border: 1px solid var(--border-color);
            padding: 14px 16px;
        }
        .parking-spots-title {
            margin: 0 0 8px;
            font-size: 16px;
        }
        .parking-spots-note {
            margin: 0 0 12px;
            font-size: 13px;
            color: var(--muted-text);
        }
        .parking-spots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
        }

        .parking-spot-card {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .parking-spot-card-title {
            font-size: 13px;
            color: var(--muted-text-2);
        }

        .parking-spot-btn {
            width: 100%;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            background: var(--chip-bg);
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 32px;
            transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease, box-shadow 0.05s ease;
        }
        .parking-spot-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.2);
        }

        .parking-spot-status {
            display: block;
            line-height: 1.25;
        }

        .parking-spot-btn--free {
            border-color: #22c55e;
            background: rgba(22, 163, 74, 0.1);
            color: #bbf7d0;
        }

        .parking-spot-btn--busy {
            border-color: #3b82f6;
            background: rgba(37, 99, 235, 0.09);
            color: #bfdbfe;
        }

        .parking-spot-btn--long {
            border-color: #020617;
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
        }
		
		/* Светлая тема: делаем текст контрастным */
body:not(.dark-theme) .parking-spot-btn--free { color: #166534; }
body:not(.dark-theme) .parking-spot-btn--busy { color: #1e40af; }


        .parking-spots-group-title {
            font-size: 14px;
            margin: 16px 0 6px;
            color: var(--muted-text-2);
        }

        @media (max-width: 768px) {
            .parking-layout {
                margin-top: 12px;
            }
        }



/* Фуллскрин карта парковки — без изменения масштаба картинки */
.parking-layout-fullscreen {
    position: fixed;
    inset: 0;
    z-index: 60;
    background: #020617;
    padding-top: 8px;
    overflow: auto;              /* даём прокручивать, не режем высоту */
}

/* просто растягиваем фигуру по ширине, как в обычном режиме */
.parking-layout-fullscreen .parking-figure-top {
    max-width: 100%;
    margin: 0;
}

/* На мобильных в режиме "Карта" увеличиваем ВСЮ схему (фон + машинки + цифры) */
@media (max-width: 768px) {
    .parking-layout-fullscreen .parking-figure-top {
        max-width: none;
        width: 100%;              /* сама фигура во всю ширину */
    }

    .parking-layout-fullscreen .parking-image-wrapper {
        overflow: visible;
        transform: scale(1.35);   /* степень "зума" — можно 1.2–1.5 по вкусу */
        transform-origin: top left;
    }
}


/* ничего не меняем у image-wrapper и img,
   чтобы сохранялся прежний масштаб и позиции хотспотов */


/* Кнопка "развернуть карту" */
.parking-fullscreen-toggle {
    position: absolute;
    top: 8px;
    left: 8px;
    z-index: 20;
    border: none;
    border-radius: 999px;
    padding: 6px 10px;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: rgba(15, 23, 42, 0.9);
    color: #e5e7eb;
    cursor: pointer;
}

.parking-fullscreen-toggle .icon-collapse {
    display: none;
}

.parking-fullscreen-toggle.is-active .icon-expand {
    display: none;
}

.parking-fullscreen-toggle.is-active .icon-collapse {
    display: inline;
}

/* на десктопе кнопку не показываем */
@media (min-width: 769px) {
    .parking-fullscreen-toggle {
        display: none;
    }
}

/* Мобильная версия: отдельные размеры для 1–8 и 9–12 */
@media (max-width: 640px) {
    /* слот 1–8 */
    .parking-hotspot {
        width: 27px;
        height: 13px;
    }

    /* слот 9–12 — чуть длиннее и шире */
    .parking-hotspot.parking-hotspot--blocking {
        width: 34px;
        height: 16px;
    }

    /* машинка 1–8 — меньше и ближе к центру слота */
    .parking-hotspot-car {
        top: 175%;
        width: 65% !important;
    }

    /* машинка 9–12 — ещё компактнее и чуть выше */
    .parking-hotspot.parking-hotspot--blocking .parking-hotspot-car {
        top: 75%;
        width: 50% !important;
    }

    /* цифры чуть поменьше и пониже */
    .parking-hotspot-label {
        font-size: 9px;
        transform: translateY(4px);
    }
	    /* На мобильной цифры 9–12 поднимаем чуть выше */
    .parking-hotspot.parking-hotspot--blocking .parking-hotspot-label {
        transform: translate(-11px, 4px);
    }

	/* ↓↓↓ уменьшение значков на мобилке ↓↓↓ */
    .parking-marker {
        width: 14px;
        height: 14px;
    }

    .parking-marker-img {
        width: 100%;
        height: auto;
		    /* Увеличиваем "зону тапа" на мобилке: визуально не меняем, но попадать пальцем проще */
    .parking-hotspot,
    .parking-marker {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }

    /* Невидимый хитбокс вокруг кнопки/маркера */
    .parking-hotspot::before,
    .parking-marker::before {
        content: "";
        position: absolute;
        inset: -8px;           /* насколько расширяем область нажатия */
    }

    /* Перекрывающие 9–12 обычно сложнее тапать — дадим чуть больше поля */
    .parking-hotspot.parking-hotspot--blocking::before {
        inset: -10px;
    }

    }
}


        /* Модалка */

        .parking-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            padding: 16px;
        }

        .parking-modal-backdrop.is-open {
            display: flex;
        }

        .parking-modal {
            max-width: 380px;
            width: 100%;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px 18px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
            font-size: 14px;
        }

        .parking-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .parking-modal-title {
            margin: 0;
            font-size: 16px;
        }

        .parking-modal-close {
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0 4px;
        }

        .parking-modal-body {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .parking-modal-row {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
/* Строка "Статус: ..." в одну линию */
.parking-modal-row.parking-modal-row-inline {
    display: flex;
    flex-direction: row; /* <-- ВАЖНО: перебиваем column */
    align-items: center;
    justify-content: flex-start;
    gap: 12px;
}

.parking-modal-status-inline {
    text-align: right;
    white-space: nowrap;
}

        .parking-modal-owner-photo {
            margin-top: 6px;
        }

        .parking-modal-owner-photo img {
            max-width: 100%;
            border-radius: 8px;
            display: block;
            cursor: pointer;
        }

        .parking-modal-label {
            font-size: 12px;
            color: var(--muted-text);
        }

        .parking-modal-input,
        .parking-modal-input[type="datetime-local"] {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 6px 8px;
            background: transparent;
            color: var(--text-color);
            font-size: 13px;
        }

        .parking-modal-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(75, 107, 255, 0.2);
        }

        .parking-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 4px;
        }

        .parking-btn {
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid transparent;
            background: var(--chip-bg);
        }

        .parking-btn-primary {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
        }

        .parking-btn-primary:hover {
            background: var(--accent-hover);
        }

        .parking-btn-secondary {
    border-color: var(--border-color);
    color: var(--text-color);
    background: transparent;
}

.parking-btn-secondary:hover {
    background: var(--nav-hover-bg);
}


        .parking-btn-danger {
            border-color: #b91c1c;
            color: #fee2e2;
            background: #7f1d1d;
        }

        .parking-modal-hint {
            font-size: 12px;
            color: var(--muted-text-2);
        }
		/* --- Пресеты времени "до" --- */
.parking-until-presets{
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 8px;
}

.parking-until-presets-row{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.parking-until-preset,
.parking-until-more{
  border-radius: 999px;
  border: 1px solid var(--border-color);
  background: var(--chip-bg);
  color: var(--text-color);
  padding: 8px 10px;
  font-size: 13px;
  cursor: pointer;
  line-height: 1;
}

.parking-until-preset:hover,
.parking-until-more:hover{
  background: var(--nav-hover-bg);
}

.parking-until-presets-more{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

/* --- Позвонить + таймер до конца брони (в модалке) --- */
.parking-call-link{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  margin-left:8px;
  width:28px;
  height:28px;
  border-radius:999px;
  background: rgba(34,197,94,0.15);
  border: 1px solid rgba(34,197,94,0.35);
  text-decoration:none;
  font-size:16px;
  line-height:1;
}
.parking-call-link:hover{ background: rgba(34,197,94,0.25); }
.parking-call-link span{ color:#22c55e; }

.parking-until-row{
  display:flex;
  align-items:center;
  gap:8px;
}
.parking-until-countdown{
  margin-left:auto;
  font-variant-numeric: tabular-nums;
  font-weight:600;
  opacity:0.9;
  background: rgba(148,163,184,0.12);
  border:1px solid rgba(148,163,184,0.25);
  border-radius:999px;
  padding:3px 10px;
}
/* На мобилке вместо "Осталось:" показываем иконку ⏳ */
@media (max-width: 520px) {
  .parking-until-left {
    font-size: 0; /* прячем текст */
  }
  .parking-until-left::before {
    content: "⏳";
    font-size: 14px;
    line-height: 1;
  }
}

.parking-clock-icon{ opacity:0.9; }

        .parking-modal-error {
            font-size: 12px;
            color: #f87171;
            display: none;
        }

        .parking-modal-error.is-visible {
            display: block;
        }
		

/* Занято / надолго — подсвечиваем МАШИНКУ только при наведении */
.parking-hotspot--occupied:hover .parking-hotspot-car,
.parking-hotspot--occupied-other:hover .parking-hotspot-car {
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.95) !important;
}

.parking-hotspot--long-term:hover .parking-hotspot-car {
    box-shadow:
        0 0 0 1px #3b2f2a,
        0 0 0 3px rgba(75, 56, 35, 0.45) !important;
}
.parking-modal-owner-photo {
    margin-top: 8px;
}

.guest-pending-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.65);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 6000;
  padding: 16px;
}
.guest-pending-overlay.is-open{ display:flex; }

.guest-pending-card{
  width: min(560px, 100%);
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 18px;
  padding: 16px;
  box-shadow: var(--shadow-soft);
}
.guest-pending-title{ margin: 0 0 8px 0; }
.guest-pending-text{ margin: 6px 0; opacity: .92; }
.guest-pending-status{ margin-top: 10px; opacity: .85; }
.guest-pending-status-row{
  margin-top: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

/* чтобы старый margin-top у .guest-pending-status не ломал выравнивание в строке */
.guest-pending-status-row .guest-pending-status{
  margin-top: 0;
}
        /* --- Мобильная модалка: удобочитаемость --- */
        @media (max-width: 768px) {
            .parking-modal {
                width: 96vw;
                max-width: 96vw;
                margin: 0 auto;
                border-radius: 16px;
				
				max-height: 88vh;
                display: flex;
                flex-direction: column;

            }

            .parking-modal-header {
                padding: 12px 14px;
            }

            .parking-modal-title {
                font-size: 18px;
                line-height: 1.2;
            }

            .parking-modal-body {
                padding: 12px 14px;
                font-size: 16px;
                line-height: 1.35;
				overflow: auto;
                -webkit-overflow-scrolling: touch;
				margin-bottom: 0;

            }

            .parking-modal-body input,
            .parking-modal-body select,
            .parking-modal-body textarea {
                font-size: 16px; /* важно для iOS, чтобы не зумил */
                padding: 10px 12px;
            }

            .parking-modal-footer {
                position: sticky;
                bottom: 0;
                background: #fff;
                padding: 10px 12px;
                border-top: 1px solid rgba(0,0,0,.08);
                display: flex;
                gap: 10px;
            }

            .parking-modal-footer .parking-btn {
                flex: 1;
                padding: 12px 10px;
                font-size: 16px;
            }

            .parking-modal-close {
                font-size: 28px;
                line-height: 1;
                padding: 4px 10px;
            }
        }

    </style>

    <!-- ВЕРХНЯЯ КАРТА (во всю ширину секции) -->
    <div class="parking-layout">
        <figure class="parking-figure parking-figure-top">
            <figcaption>Схема парковки — перед подъездами</figcaption>
            <div class="parking-image-wrapper">

                <!-- Кнопка фуллскрина карты (видна только на мобилке) -->
                <button type="button"
                        id="parkingFullscreenToggle"
                        class="parking-fullscreen-toggle"
                        aria-pressed="false">
                    <span class="icon-expand">⤢</span>
                    <span class="icon-collapse">✕</span>
                    Zoom
                </button>
				<div class="parking-map-inner" id="parkingMapInner">

                <!-- Фон карты -->
                <img src="{{ url_for('static', filename='img/parking_top.png') }}"
                     alt="Схема парковки, верхняя часть"
                     class="parking-map-bg">

                <!-- Значки-подсказки -->
                <!-- крестики: "не паркуемся" -->
                <button
                    class="parking-marker"
                    data-message="В данных местах не паркуемся, чтоб не ограничивать движение!"
                    style="top: 24%; left: 25.5%;">
                    <img src="{{ url_for('static', filename='img/parking_sign_nopark.png') }}"
                         alt="Здесь не паркуемся"
                         class="parking-marker-img">
                </button>

                <button
                    class="parking-marker"
                    data-message="В данных местах не паркуемся, чтоб не ограничивать движение!"
                    style="top: 70%; left: 22%;">
                    <img src="{{ url_for('static', filename='img/parking_sign_nopark.png') }}"
                         alt="Здесь не паркуемся"
                         class="parking-marker-img">
                </button>

                <button
                    class="parking-marker"
                    data-message="Внимательно паркуйтесь в данных местах!"
                    style="top: 67%; left: 7%;">
                    <img src="{{ url_for('static', filename='img/parking_sign_warning.png') }}"
                         alt="Внимательно паркуйтесь"
                         class="parking-marker-img">
                </button>

                <!-- восклицательные: "внимательно паркуемся" -->
                <button
                    class="parking-marker"
                    data-message="Внимательно паркуйтесь в данных местах"
                    style="top: 40%; left: 25%;">
                    <img src="{{ url_for('static', filename='img/parking_sign_warning.png') }}"
                         alt="Внимательно паркуйтесь"
                         class="parking-marker-img">
                </button>

                <button
                    class="parking-marker"
                    data-message="Внимательно паркуйтесь в данных местах"
                    style="top: 29%; left: 74%;">
                    <img src="{{ url_for('static', filename='img/parking_sign_warning.png') }}"
                         alt="Внимательно паркуйтесь"
                         class="parking-marker-img">
                </button>

                <!-- Обычные места 1–8 -->
                <button class="parking-hotspot"
                        data-spot-id="1" data-spot-label="1" data-spot-type="regular"
                        style="top: 24%; left: 21.2%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="Место 1"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="Авто на месте 1"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">1</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="2" data-spot-label="2" data-spot-type="regular"
                        style="top: 18%; left: 30.1%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="Место 2"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="Авто на месте 2"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">2</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="3" data-spot-label="3" data-spot-type="regular"
                        style="top: 18%; left: 36%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="Место 3"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="Авто на месте 3"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">3</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="4" data-spot-label="4" data-spot-type="regular"
                        style="top: 18%; left: 41.9%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="Место 4"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="Авто на месте 4"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">4</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="5" data-spot-label="5" data-spot-type="regular"
                        style="top: 18%; left: 49.8%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="Место 5"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="Авто на месте 5"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">5</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="6" data-spot-label="6" data-spot-type="regular"
                        style="top: 18%; left: 55.8%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="Место 6"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="Авто на месте 6"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">6</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="7" data-spot-label="7" data-spot-type="regular"
                        style="top: 18%; left: 62%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="Место 7"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="Авто на месте 7"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">7</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="8" data-spot-label="8" data-spot-type="regular"
                        style="top: 18%; left: 68%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="Место 8"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="Авто на месте 8"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">8</span>
                </button>

                <!-- Перекрывающие места 9–12 -->
                <button class="parking-hotspot parking-hotspot--blocking"
                        data-spot-id="9" data-spot-label="9" data-spot-type="blocking"
                        style="top: 40%; left: 35%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_blocking.png') }}"
                         alt="Место 9"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_blocking.png') }}"
                         alt="Авто на месте 9"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">9</span>
                </button>

                <button class="parking-hotspot parking-hotspot--blocking"
                        data-spot-id="10" data-spot-label="10" data-spot-type="blocking"
                        style="top: 40%; left: 48%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_blocking.png') }}"
                         alt="Место 10"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_blocking.png') }}"
                         alt="Авто на месте 10"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">10</span>
                </button>

                <button class="parking-hotspot parking-hotspot--blocking"
                        data-spot-id="11" data-spot-label="11" data-spot-type="blocking"
                        style="top: 40%; left: 62%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_blocking.png') }}"
                         alt="Место 11"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_blocking.png') }}"
                         alt="Авто на месте 11"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">11</span>
                </button>

                <button class="parking-hotspot parking-hotspot--blocking"
                        data-spot-id="12" data-spot-label="12" data-spot-type="blocking"
                        style="top: 40%; left: 75%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_blocking.png') }}"
                         alt="Место 12"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_blocking.png') }}"
                         alt="Авто на месте 12"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">12</span>
                </button>

            </div>
			</div>

        </figure>
    </div>
    <details class="parking-help" id="parkingHelp">
    <summary class="parking-help-summary">
        &#128226; Как пользоваться парковкой
        <span class="parking-help-hint">(нажмите, чтобы открыть)</span>
    </summary>

    <div class="parking-help-body">
        <p class="auth-description">
        Это интерактивная схема парковки нашего двора. 
		<br>- Можно выбирать место на картинке (по номеру машинки), 
		занимать его и указывать время стоянки и контакт для связи, 
		если в профиле у вас заполнен номер телефона и номер машины,
		то эти данные заполнятся автоматически. 
		<br>- Если вы указываете время окончания парковки, то место освободится автоматически 
		в указнное время. Если время не указывать, то необходимо 
		будет освободить место в ручную. 
		<br>- Так же нажмите на установленные знаки в треугольниках. 
		<br>- Схему можно приблизить или отдалить при нажатии 
		на Zoom в левом верхнем углу на карте
        </p>
		        <p class="parking-spots-note">
            Ровно так же место можно и занять через блок ниже "Места на парковке".
			Выбираете номер с нужным свободное местом и занимаете его указав 
			примерно время когда планируете его освободить.
            Занятое место подсвечивается, при клике видно, кто и до какого времени там стоит.
        </p>
    </div>
    </details>
    <!-- БЛОК С МЕСТАМИ -->
    <div class="parking-spots">
        <h2 class="parking-spots-title">Места на парковке</h2>

        {% set regular = spots | selectattr('id', 'in', [1,2,3,4,5,6,7,8]) | list %}
        {% set blocking = spots | selectattr('type', 'equalto', 'blocking') | list %}

        {% if regular %}
            <div>
                <div class="parking-spots-group-title">Обычные места (1–8)</div>
                <div class="parking-spots-grid">
                    {% for spot in regular %}
                        <div class="parking-spot-card">
                            <div class="parking-spot-card-title">Место {{ spot.label }}</div>
                            <button
                                type="button"
                                class="parking-spot-btn"
                                data-spot-id="{{ spot.id }}"
                                data-spot-label="{{ spot.label }}"
                                data-spot-type="regular"
                            >
                                <span class="parking-spot-status" data-role="spot-status">Можно занять</span>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {% if blocking %}
            <div>
                <div class="parking-spots-group-title">Перекрывающие (9–12, телефон обязателен)</div>
                <div class="parking-spots-grid">
                    {% for spot in blocking %}
                        <div class="parking-spot-card">
                            <div class="parking-spot-card-title">Место {{ spot.label }}</div>
                            <button
                                type="button"
                                class="parking-spot-btn"
                                data-spot-id="{{ spot.id }}"
                                data-spot-label="{{ spot.label }}"
                                data-spot-type="blocking"
                            >
                                <span class="parking-spot-status" data-role="spot-status">Можно занять</span>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>

    <!-- НИЖНЯЯ КАРТА ПОД СПИСКОМ МЕСТ -->
    <figure class="parking-figure" style="margin-top: 24px;">
        <figcaption>Схема парковки - позади дома</figcaption>
        <img src="{{ url_for('static', filename='img/parking_bottom.png') }}"
             alt="Схема парковки, нижняя часть">
    </figure>

    <!-- Модальное окно места -->
    <div class="parking-modal-backdrop" id="parkingModal">
        <div class="parking-modal">
            <div class="parking-modal-header">
                <h2 class="parking-modal-title" id="parkingModalTitle">Место</h2>
                <button class="parking-modal-close" type="button" data-role="close-modal">&times;</button>
            </div>
            <div class="parking-modal-body">
                <div class="parking-modal-row parking-modal-row-inline">
                    <div class="parking-modal-label">
                        Статус — <span id="parkingModalStatus" class="parking-modal-hint parking-modal-status-inline">Свободно</span>
                    </div>
                </div>

                <!-- флаг "надолго" — только для админа -->
                <div class="parking-modal-row parking-modal-editable" id="parkingLongRow">
                    <label class="parking-modal-label" for="parkingLongTerm">
                        <input type="checkbox" id="parkingLongTerm">
                        Надолго (только админ может менять)
                    </label>
                    <div class="parking-modal-hint">
                        Если включено, остальные видят, что машина стоит здесь надолго.
                    </div>
                </div>

                <div class="parking-modal-row parking-modal-editable">
                    <label class="parking-modal-label" for="parkingUntil">
                        До какого времени планируете стоять?
                    </label>
                    <input
                        type="datetime-local"
                        id="parkingUntil"
                        class="parking-modal-input"
                        autocomplete="off"
                    >
                    <div class="parking-modal-hint">
                        Выберите дату и время нажав на поле выше или на быстрый вариант снизу
                    </div>
					<div class="parking-until-presets parking-modal-editable" id="parkingUntilPresets">
    <div class="parking-until-presets-row">
        <button type="button" class="parking-until-preset" data-until-preset="tomorrow-07">До 07:00 (завтра)</button>
        <button type="button" class="parking-until-preset" data-until-preset="tomorrow-08">До 08:00 (завтра)</button>
        <button type="button" class="parking-until-preset" data-until-preset="next-20">До 20:00</button>
        <button type="button" class="parking-until-preset" data-until-preset="next-21">До 21:00</button>
        <button type="button" class="parking-until-preset" data-until-preset="plus-1h">На 1 час</button>
        <button type="button" class="parking-until-preset" data-until-preset="plus-2h">На 2 часа</button>

        <button type="button" class="parking-until-more" id="parkingUntilMoreBtn" aria-expanded="false">
            Ещё ▾
        </button>
    </div>

    <div class="parking-until-presets-more" id="parkingUntilMore" style="display:none;"></div>
</div>

                </div>

                <div class="parking-modal-row parking-modal-editable">
                    <label class="parking-modal-label" for="parkingCarCode">
                        Номер машины
                    </label>
                    <input
                        type="text"
                        id="parkingCarCode"
                        class="parking-modal-input"
                        placeholder="418 или А777ЕТ197"
                    >
                </div>

                <div class="parking-modal-row parking-modal-editable">
                    <label class="parking-modal-label" for="parkingPhone">
                        Телефон для связи
                    </label>
                    <input type="tel" id="parkingPhone" class="parking-modal-input" placeholder="+7 900 000-00-00">
                    <label class="parking-modal-label">
                        <input type="checkbox" id="parkingShowPhone" checked>
                        Показывать телефон соседям на этом месте
                    </label>
                </div>

                <div class="parking-modal-row" id="parkingModalOwnerRow">
                    <div class="parking-modal-label">
                        Текущий владелец — <span id="parkingModalOwnerTop" class="parking-modal-hint">—</span>
                    </div>

                    <div id="parkingModalOwnerBottom" class="parking-modal-hint"></div>
                    <div id="parkingModalOwnerNote" class="parking-modal-hint"></div>
                </div>

				<!-- Фото машины гостя, если есть -->
<div id="parkingModalOwnerPhoto" style="display: none; margin-top: 4px;">
    <a id="parkingModalOwnerPhotoLink" href="#" target="_blank">
        <img
            id="parkingModalOwnerPhotoImg"
            src=""
            alt="Фото машины гостя"
            style="max-width: 100%; border-radius: 8px; display: block;"
        >
    </a>
</div>



                <div id="parkingModalError" class="parking-modal-error"></div>
            </div>
<div class="parking-modal-footer">
    <button type="button" class="parking-btn parking-btn-secondary" data-role="cancel-modal">
        Закрыть
    </button>

    <!-- Новая кнопка подписки -->
    <button
        type="button"
        class="parking-btn parking-btn-secondary"
        id="parkingSubscribeBtn"
        style="display: none;"
    >
        Оповестить, когда освободится
    </button>

    <button type="button" class="parking-btn parking-btn-danger parking-modal-editable" id="parkingFreeBtn" style="display:none;">
        Освободить место
    </button>
    <button type="button" class="parking-btn parking-btn-primary parking-modal-editable" id="parkingSaveBtn">
        Занять место
    </button>
</div>

        </div>
    </div>
    <!-- Модалка подтверждения: занять ещё одно место -->
    <div class="parking-modal-backdrop" id="parkingConfirmMultiModal">
        <div class="parking-modal">
            <div class="parking-modal-header">
                <h2 class="parking-modal-title">Занять ещё одно место?</h2>
                <button class="parking-modal-close" type="button" data-role="confirm-multi-cancel">&times;</button>
            </div>

            <div class="parking-modal-body">
                <div class="parking-modal-hint" id="confirmMultiText">
                    У вас уже есть занятые места.
                </div>
                <div id="confirmMultiList" class="parking-modal-hint" style="opacity:.9;"></div>
            </div>

            <div class="parking-modal-footer">
                <button type="button" class="parking-btn parking-btn-secondary" data-role="confirm-multi-cancel">
                    Отмена
                </button>
                <button type="button" class="parking-btn parking-btn-primary" id="confirmMultiOkBtn">
                    Занять ещё одно
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const root = document.getElementById("parking-root");
            const userApartment = (root.dataset.userApartment || "").trim();
            const isAdmin = root.dataset.userIsAdmin === "1";
            const userPhone = (root.dataset.userPhone || "").trim();
            const userCarNumber = (root.dataset.userCarNumber || "").trim();
			const canSubscribe = root.dataset.userCanSubscribe === "1";
			const isGuest = root.dataset.userIsGuest === "1";
let guestStatus = (root.dataset.userGuestStatus || "").trim().toLowerCase();

const guestOverlay = document.getElementById("guestPendingOverlay");
const guestStatusEl = document.getElementById("guestPendingStatus");
const guestCheckBtn = document.getElementById("guestPendingCheckBtn");

function setGuestOverlayVisible(visible){
  if (!guestOverlay) return;
  if (visible){
    guestOverlay.classList.add("is-open");
    guestOverlay.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  } else {
    guestOverlay.classList.remove("is-open");
    guestOverlay.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }
}

let guestStatusTimer = null;

async function pollGuestApproval(){
  if (!isGuest) return;

  try{
    const r = await fetch("/api/guest/status", {
      headers: { "X-Requested-With":"XMLHttpRequest" }
    });
    const d = await r.json().catch(()=> ({}));

    if (!r.ok || !d.ok){
      if (guestStatusEl) guestStatusEl.textContent = "Не удалось проверить статус. Обновите страницу.";
      setGuestOverlayVisible(true);
      return;
    }

    const st = String(d.status || "pending").toLowerCase();
    guestStatus = st;

    const rej = document.getElementById("guestPendingRejected");

    if (st === "approved"){
      if (rej) rej.style.display = "none";
      setGuestOverlayVisible(false);

      await fetchSpotsAndRefresh();

      if (guestStatusTimer){
        clearInterval(guestStatusTimer);
        guestStatusTimer = null;
      }
      return;
    }

    if (st === "rejected"){
      if (guestStatusEl) guestStatusEl.textContent = "Заявка отклонена.";
      if (rej) rej.style.display = "block";
      setGuestOverlayVisible(true);
      return;
    }

    // pending / unknown
    if (guestStatusEl) guestStatusEl.textContent = "Ожидает одобрения администратора…";
    if (rej) rej.style.display = "none";
    setGuestOverlayVisible(true);

  } catch(e){
    if (guestStatusEl) guestStatusEl.textContent = "Ошибка сети при проверке статуса.";
    setGuestOverlayVisible(true);
  }
}

// включаем оверлей сразу, если гость и не approved
if (isGuest && guestStatus !== "approved") {
  setGuestOverlayVisible(true);
  pollGuestApproval();
  guestStatusTimer = setInterval(pollGuestApproval, 15000);
}
if (guestCheckBtn) {
  guestCheckBtn.addEventListener("click", async () => {
    if (guestStatusEl) guestStatusEl.textContent = "Проверяем статус…";
    await pollGuestApproval();
  });
}

            // --- Режим "Только схема" (мобильный) ---
const compactBtn = document.getElementById("parkingCompactToggle");
const COMPACT_KEY = "parking_compact_mode";

function applyCompactMode(on) {
    if (!root) return;
    root.classList.toggle("parking-compact", !!on);
	// если включаем "Упростить" — выходим из fullscreen/zoom режима
if (on) {
    const layoutEl = document.querySelector(".parking-layout");
    const fsBtn = document.getElementById("parkingFullscreenToggle");
    if (layoutEl) layoutEl.classList.remove("parking-layout-fullscreen");
    if (fsBtn) {
        fsBtn.classList.remove("is-active");
        fsBtn.setAttribute("aria-pressed", "false");
    }
}


    if (compactBtn) {
        compactBtn.textContent = on ? "Расширить" : "Упростить";
        compactBtn.setAttribute("aria-pressed", on ? "true" : "false");
    }
}

if (compactBtn) {
    // восстановить выбор
    let saved = false;
    try {
        saved = localStorage.getItem(COMPACT_KEY) === "1";
    } catch (_) {
        saved = false;
    }
    applyCompactMode(saved);
	// --- Справка: на ПК открыта, на телефоне закрыта ---
const helpEl = document.getElementById("parkingHelp");
if (helpEl) {
    const isMobile = window.matchMedia && window.matchMedia("(max-width: 768px)").matches;
    // на мобиле закрыто, на ПК открыто
    helpEl.open = !isMobile;

    // если включили "Только схема", справку тоже закрываем
    if (root && root.classList.contains("parking-compact")) {
        helpEl.open = false;
    }

    // когда пользователь переключает режим — не трогаем help автоматически,
    // кроме случая включения compact (тогда закрываем)
    if (compactBtn) {
        compactBtn.addEventListener("click", () => {
            const nowCompact = root.classList.contains("parking-compact");
            if (nowCompact) helpEl.open = false;
        });
    }
}

    compactBtn.addEventListener("click", () => {
        const nowOn = !root.classList.contains("parking-compact");
        applyCompactMode(nowOn);
        try {
            localStorage.setItem(COMPACT_KEY, nowOn ? "1" : "0");
        } catch (_) {}
    });
}

			const modalBackdrop = document.getElementById("parkingModal");
            const modalTitle = document.getElementById("parkingModalTitle");
            const modalStatus = document.getElementById("parkingModalStatus");
            const modalOwnerTop = document.getElementById("parkingModalOwnerTop");
            const modalOwnerBottom = document.getElementById("parkingModalOwnerBottom");
            const modalOwnerNote = document.getElementById("parkingModalOwnerNote");
			const modalOwnerRow = document.getElementById("parkingModalOwnerRow");

            const modalError = document.getElementById("parkingModalError");
			// --- Модалка подтверждения "занять ещё одно место" ---
const confirmMultiBackdrop = document.getElementById("parkingConfirmMultiModal");
const confirmMultiText = document.getElementById("confirmMultiText");
const confirmMultiList = document.getElementById("confirmMultiList");
const confirmMultiOkBtn = document.getElementById("confirmMultiOkBtn");

let confirmMultiResolver = null;

function openConfirmMultiModal(occupiedArr, maxAllowed) {
    return new Promise((resolve) => {
        confirmMultiResolver = resolve;

        const occupied = (occupiedArr || []).filter(Boolean);
        const occupiedStr = occupied.length ? occupied.join(", ") : "—";

        if (confirmMultiText) {
            confirmMultiText.textContent = `У вас уже заняты места: ${occupiedStr}. Разрешено до ${maxAllowed}.`;
        }
        if (confirmMultiList) {
            confirmMultiList.textContent = "Подтвердите, что вы действительно хотите занять ещё одно место.";
        }

        if (confirmMultiBackdrop) confirmMultiBackdrop.classList.add("is-open");
    });
}

function closeConfirmMultiModal(result) {
    if (confirmMultiBackdrop) confirmMultiBackdrop.classList.remove("is-open");
    if (confirmMultiResolver) {
        const r = confirmMultiResolver;
        confirmMultiResolver = null;
        r(!!result);
    }
}

// закрываем ТОЛЬКО по кнопкам/крестику (как у вас в основной модалке)
if (confirmMultiBackdrop) {
    confirmMultiBackdrop.addEventListener("click", (e) => {
        const role = e.target.dataset.role;
        if (role === "confirm-multi-cancel") {
            closeConfirmMultiModal(false);
        }
    });
}
if (confirmMultiOkBtn) {
    confirmMultiOkBtn.addEventListener("click", () => closeConfirmMultiModal(true));
}



            // блок с фото + ссылка + сама картинка
            const modalOwnerPhotoBox  = document.getElementById("parkingModalOwnerPhoto");
            const modalOwnerPhotoLink = document.getElementById("parkingModalOwnerPhotoLink");
            const modalOwnerPhotoImg  = document.getElementById("parkingModalOwnerPhotoImg");

            const inputUntil = document.getElementById("parkingUntil");
            const inputCarCode = document.getElementById("parkingCarCode");
            const inputPhone = document.getElementById("parkingPhone");
            const inputShowPhone = document.getElementById("parkingShowPhone");
            const inputLongTerm = document.getElementById("parkingLongTerm");
            const longRow = document.getElementById("parkingLongRow");
            const btnSave = document.getElementById("parkingSaveBtn");
            const btnFree = document.getElementById("parkingFreeBtn");
			const btnSubscribe = document.getElementById("parkingSubscribeBtn");
            const editableRows = document.querySelectorAll(".parking-modal-editable");

            let currentSpotId = null;
            let currentSpotType = null;
            let currentSpotData = null;

            // календарь по клику на поле
            if (inputUntil && typeof inputUntil.showPicker === "function") {
                const openPicker = () => inputUntil.showPicker();
                inputUntil.addEventListener("click", openPicker);
                inputUntil.addEventListener("focus", openPicker);
            }
			// --- Пресеты времени для "До какого времени" ---
const untilPresetsWrap = document.getElementById("parkingUntilPresets");
const untilMoreBtn = document.getElementById("parkingUntilMoreBtn");
const untilMoreBox = document.getElementById("parkingUntilMore");

function pad2(n){ return String(n).padStart(2, "0"); }

function toDatetimeLocalValue(dt){
  const y = dt.getFullYear();
  const m = pad2(dt.getMonth() + 1);
  const d = pad2(dt.getDate());
  const hh = pad2(dt.getHours());
  const mm = pad2(dt.getMinutes());
  return `${y}-${m}-${d}T${hh}:${mm}`;
}

function setUntil(dt){
  if (!inputUntil) return;
  try {
    dt.setSeconds(0, 0);
  } catch(_) {}
  inputUntil.value = toDatetimeLocalValue(dt);
  inputUntil.dispatchEvent(new Event("change", { bubbles: true }));
  try { inputUntil.blur(); } catch(_) {}
}

function nextOccurrenceAt(hour, minute){
  const now = new Date();
  const dt = new Date(now);
  dt.setHours(hour, minute, 0, 0);
  if (dt.getTime() <= now.getTime()) {
    dt.setDate(dt.getDate() + 1);
  }
  return dt;
}

function tomorrowAt(hour, minute){
  const dt = new Date();
  dt.setDate(dt.getDate() + 1);
  dt.setHours(hour, minute, 0, 0);
  return dt;
}

function buildMorePresets(){
  if (!untilMoreBox) return;
  untilMoreBox.innerHTML = "";
  // --- "До HH:00" ближайшие варианты (шаг 1 час) ---
const now = new Date();
const nextHour = new Date(now);
nextHour.setMinutes(0, 0, 0);
nextHour.setHours(nextHour.getHours() + 1);

// 10 ближайших "До"
for (let i = 0; i < 10; i++) {
  const dt = new Date(nextHour.getTime() + i * 60 * 60 * 1000);
  const hh = pad2(dt.getHours());
  const b = document.createElement("button");
  b.type = "button";
  b.className = "parking-until-preset";
  b.textContent = `До ${hh}:00`;
  b.addEventListener("click", () => setUntil(dt));
  untilMoreBox.appendChild(b);
}

// перенос строки перед "На 3/4 часа"
const sep = document.createElement("div");
sep.style.flexBasis = "100%";
sep.style.height = "0";
untilMoreBox.appendChild(sep);


// короткие шаги: 3..4 часа (остальное — руками в календаре)
const hoursList = [3,4];

  hoursList.forEach((h) => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "parking-until-preset";
    b.textContent = `На ${h} ${h === 1 ? "час" : (h >= 2 && h <= 4 ? "часа" : "часов")}`;
    b.addEventListener("click", () => {
      const dt = new Date(Date.now() + h * 60 * 60 * 1000);
      setUntil(dt);
    });
    untilMoreBox.appendChild(b);
  });
}

function toggleMore(open){
  if (!untilMoreBtn || !untilMoreBox) return;
  untilMoreBox.style.display = open ? "flex" : "none";
  untilMoreBtn.setAttribute("aria-expanded", open ? "true" : "false");
  untilMoreBtn.textContent = open ? "Скрыть ▴" : "Ещё ▾";
  if (open) buildMorePresets();
}

if (untilPresetsWrap && inputUntil) {
  // клики по основным пресетам
  untilPresetsWrap.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-until-preset]");
    if (!btn) return;

    e.preventDefault();

    const preset = String(btn.getAttribute("data-until-preset") || "");
    if (preset === "tomorrow-07") setUntil(tomorrowAt(7, 0));
    else if (preset === "tomorrow-08") setUntil(tomorrowAt(8, 0));
    else if (preset === "next-20") setUntil(nextOccurrenceAt(20, 0));
    else if (preset === "next-21") setUntil(nextOccurrenceAt(21, 0));
    else if (preset === "plus-1h") setUntil(new Date(Date.now() + 1 * 60 * 60 * 1000));
    else if (preset === "plus-2h") setUntil(new Date(Date.now() + 2 * 60 * 60 * 1000));
  });

  if (untilMoreBtn) {
    untilMoreBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const isOpen = untilMoreBtn.getAttribute("aria-expanded") === "true";
      toggleMore(!isOpen);
    });
  }
}

let untilCountdownTimer = null;

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function normalizeTelHref(phone){
  const s = String(phone || "").trim();
  const cleaned = s.replace(/[^\d+]/g, "");
  return cleaned || s;
}

function parseIsoLocal(untilStr){
  const m = /^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2})/.exec(String(untilStr || ""));
  if (!m) return null;
  const dt = new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], 0, 0);
  if (Number.isNaN(dt.getTime())) return null;
  return dt;
}

function formatDateTimeRu(untilStr){
  const dt = parseIsoLocal(untilStr);
  if (!dt) return null;
  const dd = String(dt.getDate()).padStart(2,"0");
  const mm = String(dt.getMonth()+1).padStart(2,"0");
  const yyyy = dt.getFullYear();
  const hh = String(dt.getHours()).padStart(2,"0");
  const mi = String(dt.getMinutes()).padStart(2,"0");
  return { date:`${dd}.${mm}.${yyyy}`, time:`${hh}:${mi}`, ts: dt.getTime() };
}

function stopUntilCountdown(){
  if (untilCountdownTimer){
    clearInterval(untilCountdownTimer);
    untilCountdownTimer = null;
  }
}

function startUntilCountdown(untilStr){
  stopUntilCountdown();
  const parts = formatDateTimeRu(untilStr);
  if (!parts) return;
  const el = document.getElementById("parkingUntilCountdown");
  if (!el) return;

  function tick(){
    const diff = parts.ts - Date.now();
    if (diff <= 0){
      el.textContent = "00:00";
      stopUntilCountdown();
      return;
    }
    const totalMin = Math.max(0, Math.ceil(diff / 60000));
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    el.textContent = `${h}:${String(m).padStart(2, "0")}`;
  }

  tick();
  untilCountdownTimer = setInterval(tick, 15000);
}

            function formatUntilText(untilStr) {
                if (!untilStr) {
                    return "Занято";
                }
                const dt = new Date(untilStr);
                if (isNaN(dt.getTime())) {
                    return "Занято";
                }

                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const target = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
                const diffDays = Math.round((target - today) / 86400000);

                const timeStr = dt.toLocaleTimeString("ru-RU", {
                    hour: "2-digit",
                    minute: "2-digit"
                });

                let dayPart;
                if (diffDays === 0) {
                    dayPart = "сегодня";
                } else if (diffDays === 1) {
                    dayPart = "завтра";
                } else if (diffDays === 2) {
                    dayPart = "послезавтра";
                } else {
                    const d = String(dt.getDate()).padStart(2, "0");
                    const m = String(dt.getMonth() + 1).padStart(2, "0");
                    const y = dt.getFullYear();
                    dayPart = `${d}.${m}.${y}`;

                }

                return `Занято до ${dayPart} 🕒 ${timeStr}`;
            }

            function openModalForSpot(el, spotData) {
                currentSpotId = parseInt(el.dataset.spotId, 10);
                currentSpotType = el.dataset.spotType;
                currentSpotData = spotData || null;

                modalError.classList.remove("is-visible");
                modalError.textContent = "";

                const label = el.dataset.spotLabel;
                modalTitle.textContent = `Место ${label}`;

                const occ = spotData && spotData.occupied && spotData.occupant ? spotData.occupant : null;
                const longTerm = occ && occ.long_term;

               if (occ) {
    if (modalOwnerRow) modalOwnerRow.style.display = "flex";		   
    let who;

    if (
        occ.is_guest ||
        (occ.apartment && String(occ.apartment).toLowerCase() === "гость") ||
        (occ.apartment && /^g\d+$/i.test(String(occ.apartment)))
    ) {
        const guestName = (occ.name || "").trim();
        who = guestName ? `Гость ${guestName}` : "Гость";
    } else if (occ.apartment) {
        who = `Кв. ${occ.apartment}`;
    } else {
        who = "Неизвестно";
    }

    const car = (occ.car_code || occ.car_number || "").trim();
    const phone = (occ.phone || "").trim();

    // --- СТАТУС (с таймером справа) ---
    if (longTerm) {
        stopUntilCountdown();
        modalStatus.textContent = "Занято (надолго)";
    } else if (occ.until) {
modalStatus.innerHTML =
  `<div class="parking-until-row">` +
  `<span>${escapeHtml(formatUntilText(occ.until))}</span>` +
  `<span class="parking-until-left">Осталось:</span>` +
  `<span id="parkingUntilCountdown" class="parking-until-countdown"></span>` +
  `</div>`;

        startUntilCountdown(occ.until);
    } else {
        stopUntilCountdown();
        modalStatus.textContent = "Занято";
    }

    // --- ВЛАДЕЛЕЦ (телефон + кнопка звонка 📞) ---
    const phoneText = phone ? `, тел. ${escapeHtml(phone)}` : "";
    const carText = car ? `, авто ${escapeHtml(car)}` : "";
    const callBtn = phone
        ? ` <a class="parking-call-link" href="tel:${escapeHtml(normalizeTelHref(phone))}" title="Позвонить"><span>📞</span></a>`
        : "";

    if (modalOwnerTop) {
    modalOwnerTop.textContent = car ? `${who}, авто ${car}` : `${who}`;
}
if (modalOwnerBottom) {
    modalOwnerBottom.innerHTML = phone
        ? `Тел. ${escapeHtml(phone)}${callBtn}`
        : "";
}
if (modalOwnerNote) {
    modalOwnerNote.textContent = ""; // сюда ниже положим текст про права
}

} else {
    stopUntilCountdown();
    modalStatus.textContent = "Свободно";

    // скрываем весь блок "Текущий владелец / Телефон / подсказки" — чтобы не было дублей
    if (modalOwnerRow) modalOwnerRow.style.display = "none";

    // на всякий случай чистим значения (если модалка открывалась до этого на занятом месте)
    if (modalOwnerTop) modalOwnerTop.textContent = "";
    if (modalOwnerBottom) modalOwnerBottom.textContent = "";
    if (modalOwnerNote) modalOwnerNote.textContent = "";
}


// показать / скрыть фото гостя
if (modalOwnerPhotoBox && modalOwnerPhotoImg && modalOwnerPhotoLink) {
    if (
    occ &&
    (
        occ.is_guest ||
        (occ.apartment && /^g\d+$/i.test(String(occ.apartment))) ||
        (occ.apartment && String(occ.apartment).toLowerCase() === "гость")
    ) &&
    occ.guest_photo
) {

        let src = occ.guest_photo;

        // если путь относительный — добавляем /static/
        if (src && !src.startsWith("http")) {
            src = "/static/" + src.replace(/^\/+/, "");
        }

        modalOwnerPhotoImg.src = src;
        modalOwnerPhotoImg.alt = "Фото машины гостя";
        modalOwnerPhotoLink.href = src;

        modalOwnerPhotoBox.style.display = "block";
    } else {
        // скрываем блок, если фото нет или это не гость
        modalOwnerPhotoImg.src = "";
        modalOwnerPhotoLink.href = "#";
        modalOwnerPhotoBox.style.display = "none";
    }
}



                const occupiedByMe = !!(occ && occ.apartment === userApartment);
                const occupied = !!occ;
                const readOnly = occupied && !occupiedByMe && !isAdmin;
				
				// показать / скрыть кнопку подписки
if (btnSubscribe) {
    if (canSubscribe && occupied && !occupiedByMe) {
        // место занято не мной, подписки разрешены
        btnSubscribe.style.display = "inline-block";
        btnSubscribe.disabled = false;
    } else {
        btnSubscribe.style.display = "none";
    }
}


                // показать/скрыть редактируемые поля
                editableRows.forEach((row) => {
                    row.style.display = readOnly ? "none" : (row.tagName === "BUTTON" ? "inline-block" : "flex");
                });

                // галочка "надолго": видна только админу
                if (isAdmin && !readOnly) {
                    longRow.style.display = "flex";
                    inputLongTerm.disabled = false;
                    inputLongTerm.checked = !!longTerm;
                } else {
                    longRow.style.display = "none";
                    inputLongTerm.checked = !!longTerm;
                }

                // значения по умолчанию
inputUntil.value = "";
inputCarCode.value = "";
inputPhone.value = "";
inputShowPhone.checked = true;

// если место уже занято — всегда показываем данные текущего владельца
if (occ) {
    if (occ.until) inputUntil.value = occ.until.slice(0, 16); // datetime-local
    const occCarLabel = (occ.car_code || occ.car_number || "").trim();
	if (occCarLabel) inputCarCode.value = occCarLabel;
    if (occ.phone) inputPhone.value = occ.phone;
    inputShowPhone.checked = Boolean(occ.show_phone);

// если место свободно и это обычный пользователь — подставляем его профиль
} else if (!occ && !isAdmin) {
    inputCarCode.value = userCarNumber || "";
    inputPhone.value = userPhone || "";
    inputShowPhone.checked = true;
}
// если место свободно и это админ — поля остаются пустыми


                btnSave.style.display = readOnly ? "none" : "inline-block";
                btnSave.disabled = false;
                btnFree.style.display = "none";

                if (occupied && (occupiedByMe || isAdmin)) {
                    btnFree.style.display = "inline-block";
                    btnSave.textContent = occupiedByMe ? "Обновить данные" : "Занять место (как админ)";
} else if (readOnly) {
    if (modalOwnerNote) {
        modalOwnerNote.textContent = "";
    }
} else {

                    btnSave.textContent = "Занять место";
                }

                modalBackdrop.classList.add("is-open");
            }

            function closeModal() {
    modalBackdrop.classList.remove("is-open");
    currentSpotId = null;
    currentSpotData = null;
	stopUntilCountdown();

    // Прячем кнопку подписки при закрытии
    if (btnSubscribe) {
        btnSubscribe.style.display = "none";
    }
}


            function showError(msg) {
                modalError.textContent = msg;
                modalError.classList.add("is-visible");
            }

            function clearError() {
                modalError.textContent = "";
                modalError.classList.remove("is-visible");
            }

            async function fetchSpotsAndRefresh() {
                try {
                    const resp = await fetch("/api/parking/spots");
                    const data = await resp.json();
                    const list = data.spots || [];

                    const indexById = {};
                    list.forEach((s) => { indexById[String(s.id)] = s; });

                    // точки на схеме
document.querySelectorAll(".parking-hotspot").forEach((el) => {
    const sid = el.dataset.spotId;
    const info = indexById[sid];
    if (!info) return;

    const carImg = el.querySelector(".parking-hotspot-car");

    el.dataset.occupied = info.occupied ? "1" : "0";

    el.classList.remove(
        "parking-hotspot--occupied",
        "parking-hotspot--occupied-other",
        "parking-hotspot--long-term"
    );

    if (info.occupied && info.occupant) {
        const occ = info.occupant;
        const mine = occ.apartment === userApartment;

        el.classList.add("parking-hotspot--occupied");
        if (!mine && !isAdmin) {
            el.classList.add("parking-hotspot--occupied-other");
        }

        if (occ.long_term) {
            el.classList.add("parking-hotspot--long-term");
        }

        if (carImg) {
            carImg.style.display = "block";
        }

            let who;
    if (
    occ.is_guest ||
    (occ.apartment && /^g\d+$/i.test(String(occ.apartment))) ||
    (occ.apartment && String(occ.apartment).toLowerCase() === "гость")
) {

        const guestName = (occ.name || "").trim();
        who = guestName ? `Гость ${guestName}` : "Гость";
    } else if (occ.apartment) {
        who = `Кв. ${occ.apartment}`;
    } else {
        who = "Неизвестно";
    }

        const longText = occ.long_term ? " (надолго)" : "";
        el.title = occ.until
            ? `${who}, ${formatUntilText(occ.until)}${longText}`
            : `Занято: ${who}${longText}`;
    } else {
        if (carImg) {
            carImg.style.display = "none";
        }
        el.title = "Свободно";
    }
});


                    // кнопки в списке
                    document.querySelectorAll(".parking-spot-btn").forEach((el) => {
                        const sid = el.dataset.spotId;
                        const info = indexById[sid];
                        const statusEl = el.querySelector('[data-role="spot-status"]');
                        if (!statusEl) return;

                        el.classList.remove(
                            "parking-spot-btn--free",
                            "parking-spot-btn--busy",
                            "parking-spot-btn--long"
                        );

                        if (!info || !info.occupied || !info.occupant) {
                            el.classList.add("parking-spot-btn--free");
                            statusEl.textContent = "Можно занять";
                            return;
                        }

                        const occ = info.occupant;
                        if (occ.long_term) {
                            el.classList.add("parking-spot-btn--long");
                            statusEl.textContent = "Надолго";
                        } else {
                            el.classList.add("parking-spot-btn--busy");
                            statusEl.textContent = formatUntilText(occ.until);
                        }
                    });

                    return indexById;
                } catch (e) {
                    console.error(e);
                }
            }

            function setupClickHandlers() {
                function attach(el) {
                    el.addEventListener("click", async () => {
                        const all = await fetchSpotsAndRefresh();
                        const sid = el.dataset.spotId;
                        const info = all ? all[sid] : null;
                        openModalForSpot(el, info);
                    });
                }

                document.querySelectorAll(".parking-spot-btn").forEach(attach);
                document.querySelectorAll(".parking-hotspot").forEach(attach);
            }

            setupClickHandlers();
			
			            // Фуллскрин-карта на мобильных
            const layout = document.querySelector(".parking-layout");
            const fullscreenBtn = document.getElementById("parkingFullscreenToggle");

            if (layout && fullscreenBtn) {
                fullscreenBtn.addEventListener("click", () => {
                    const active = layout.classList.toggle("parking-layout-fullscreen");
                    fullscreenBtn.classList.toggle("is-active", active);
                    fullscreenBtn.setAttribute("aria-pressed", active ? "true" : "false");
                });
            }

			            // значки-подсказки на схеме
            document.querySelectorAll(".parking-marker").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const msg = btn.dataset.message || "";
                    if (msg) {
                        alert(msg);
                    }
                });
            });
fetchSpotsAndRefresh(); // первичная отрисовка занятых мест

			// --- Автообновление парковки (чтобы освобождение появлялось без F5) ---
const AUTO_REFRESH_MS = 30000; // 30 секунд
let autoRefreshTimer = null;

function startAutoRefresh() {
    if (autoRefreshTimer) return;
    autoRefreshTimer = setInterval(() => {
        if (document.visibilityState !== "visible") return;
        fetchSpotsAndRefresh();
    }, AUTO_REFRESH_MS);
}

function stopAutoRefresh() {
    if (!autoRefreshTimer) return;
    clearInterval(autoRefreshTimer);
    autoRefreshTimer = null;
}

// Когда возвращаемся на вкладку — сразу подтянуть актуальное состояние
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
        fetchSpotsAndRefresh();
    }
});

window.addEventListener("beforeunload", stopAutoRefresh);

startAutoRefresh();


            // Закрываем модалку только по кнопкам "X" и "Отмена"
            modalBackdrop.addEventListener("click", (e) => {
                const role = e.target.dataset.role;
                if (role === "close-modal" || role === "cancel-modal") {
                    closeModal();
                }
            });

            // Esc
            window.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && modalBackdrop.classList.contains("is-open")) {
                    closeModal();
                }
            });
// Подписка на место — реальный запрос к серверу
if (btnSubscribe) {
    btnSubscribe.addEventListener("click", async () => {
        if (!currentSpotId) return;
        clearError();
        btnSubscribe.disabled = true;

        try {
            const resp = await fetch(`/api/parking/spot/${currentSpotId}/subscribe`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Requested-With": "XMLHttpRequest",
                },
                body: JSON.stringify({}),
            });

            let data = {};
            try {
                data = await resp.json();
            } catch (_) {
                data = {};
            }

            if (!resp.ok || !data.ok) {
                const code = data.error || "unknown";

                if (code === "no_telegram_chat_id") {
                    showError(
                        "Нельзя оформить подписку: в профиле не привязан Telegram. " +
                        "Откройте профиль и укажите telegram_chat_id."
                    );
                } else if (code === "no_user" || code === "no_user_record") {
                    showError("Не удалось определить пользователя. Попробуйте выйти и войти заново.");
                } else if (code === "unknown_spot") {
                    showError("Это парковочное место не найдено в конфигурации.");
                } else {
                    showError("Не удалось оформить подписку. Попробуйте позже.");
                }
                return;
            }

            if (data.already) {
                showError("Вы уже подписаны на уведомление по этому месту.");
            } else {
                alert("Готово! Вы подписаны на уведомление. Когда место освободится, бот пришлёт сообщение.");
            }
        } catch (e) {
            console.error(e);
            showError("Ошибка сети при оформлении подписки.");
        } finally {
            btnSubscribe.disabled = false;
        }
    });
}

btnSave.addEventListener("click", async () => {
    if (!currentSpotId) return;
    clearError();

    const untilVal = inputUntil.value ? inputUntil.value : "";
    const phoneVal = inputPhone.value.trim();
    const carCodeVal = inputCarCode.value.trim();
    const showPhoneVal = inputShowPhone.checked;
    const longTermVal = inputLongTerm.checked;

    try {
        let forceMulti = false;

        while (true) {
            const resp = await fetch(`/api/parking/spot/${currentSpotId}/occupy`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    until: untilVal || "",
                    phone: phoneVal,
                    car_code: carCodeVal,
                    show_phone: showPhoneVal,
                    long_term: longTermVal,
                    force_multi: forceMulti
                })
            });

            const data = await resp.json();
            if (!resp.ok || !data.ok) {
                const err = data.error || "Ошибка при сохранении";

if (err === "confirm_multi") {
    const occupiedArr = (data.occupied_spots || []);
    const max = data.max_active_spots || "";
    const ok = await openConfirmMultiModal(occupiedArr, max);

    if (ok) {
        forceMulti = true;
        continue; // повторяем запрос уже с force_multi
    }

    showError("Действие отменено.");
    return;
}


                if (err === "limit_reached") {
                    const occupied = (data.occupied_spots || []).join(", ");
                    const max = data.max_active_spots || "";
                    showError(`Достигнут лимит активных мест (${max}). Сейчас заняты: ${occupied || "—"}.`);
                    return;
                }

                if (err === "spot_busy") {
                    showError("Это место сейчас занято другим пользователем.");
                    return;
                }

                if (err === "bad_until") {
                    showError("Неверный формат времени. Попробуйте ещё раз.");
                    return;
                }

                if (err === "already_has_spot") {
                    const otherId = data.current_spot_id;
                    if (otherId) {
                        showError(`У вас уже занято место №${otherId}. Сначала освободите его, затем попробуйте занять другое.`);
                    } else {
                        showError("У вас уже занято одно место. Сначала освободите его, затем попробуйте занять другое.");
                    }
                    return;
                }

                showError("Не удалось сохранить данные. Попробуйте ещё раз.");
                return;
            }

            break; // успех
        }

        await fetchSpotsAndRefresh();
        closeModal();
    } catch (e) {
        console.error(e);
        showError("Ошибка сети. Попробуйте ещё раз.");
    }
});


            btnFree.addEventListener("click", async () => {
                if (!currentSpotId) return;
                clearError();
                try {
                    const resp = await fetch(`/api/parking/spot/${currentSpotId}/free`, {
                        method: "POST"
                    });
                    const data = await resp.json();
                    if (!resp.ok || !data.ok) {
                        showError("Не удалось освободить место.");
                        return;
                    }
                    await fetchSpotsAndRefresh();
                    closeModal();
                } catch (e) {
                    console.error(e);
                    showError("Ошибка сети. Попробуйте ещё раз.");
                }
            });
        });
    </script>
</section>
{% endblock %}
