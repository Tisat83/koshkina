{% extends "base.html" %}

{% block title %}–ü–∞—Ä–∫–æ–≤–∫–∞{% endblock %}
{% block head_extra %}
<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/parking-180.png') }}?v=1">
<link rel="apple-touch-icon" sizes="167x167" href="{{ url_for('static', filename='icons/parking-167.png') }}?v=1">
<link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='icons/parking-152.png') }}?v=1">
<link rel="apple-touch-icon" sizes="120x120" href="{{ url_for('static', filename='icons/parking-120.png') }}?v=1">
<link rel="apple-touch-icon" sizes="76x76"  href="{{ url_for('static', filename='icons/parking-76.png') }}?v=1">

<meta name="apple-mobile-web-app-title" content="–ü–∞—Ä–∫–æ–≤–∫–∞">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
{% endblock %}


{% block content %}
<section
    class="info-section parking-section"
    id="parking-root"
    data-user-apartment="{{ user.get('apartment', '') }}"
    data-user-is-admin="{{ '1' if user.get('is_admin') else '0' }}"
    data-user-phone="{{ user.get('phone', '') }}"
    data-user-car-number="{{ user.get('car_code') or user.get('car_number', '') }}"
    data-user-can-subscribe="1"
	data-user-is-guest="{{ '1' if user.get('is_guest') else '0' }}"
    data-user-guest-status="{{ user.get('guest_status', '') }}"

>
<div id="guestPendingOverlay" class="guest-pending-overlay" aria-hidden="true">
  <div class="guest-pending-card">
    <h2 class="guest-pending-title">–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–∞—Ä–∫–æ–≤–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</h2>
    <p class="guest-pending-text">
      –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É. –ü–æ–∫–∞ –∑–∞—è–≤–∫–∞ –Ω–µ –æ–¥–æ–±—Ä–µ–Ω–∞, –ø–∞—Ä–∫–æ–≤–∫–∞ –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.
    </p>
    <p class="guest-pending-text">
      –ö–∞–∫ —Ç–æ–ª—å–∫–æ –∑–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∞ ‚Äî —ç—Ç–æ –æ–∫–Ω–æ –∏—Å—á–µ–∑–Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    </p>
<div class="guest-pending-status-row">
  <div class="guest-pending-status" id="guestPendingStatus">–í –æ–∂–∏–¥–∞–Ω–∏–∏ –æ–¥–æ–±—Ä–µ–Ω–∏—è‚Ä¶</div>

  <button
    type="button"
    class="parking-btn parking-btn-primary"
    id="guestPendingCheckBtn"
  >
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
  </button>
</div>

<div class="guest-pending-rejected" id="guestPendingRejected" style="display:none;">
  <h3 style="margin: 12px 0 6px 0;">–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞</h3>
  <p style="margin: 0; opacity: .92;">
    –ü—Ä–∏—á–∏–Ω—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã–µ, –Ω–æ –æ—Å–Ω–æ–≤–Ω–∞—è ‚Äî –≤–∞—à—É –º–∞—à–∏–Ω—É –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –≤–∞–º–∏ –º–µ—Å—Ç–µ.
    –ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –µ—â—ë —Ä–∞–∑ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —É–∫–∞–∑–∞–ª–∏ –≤–µ—Ä–Ω–æ–µ –º–µ—Å—Ç–æ –∏ –Ω–æ–º–µ—Ä –º–∞—à–∏–Ω—ã.
  </p>
</div>

  </div>
</div>

    <h1>–ü–∞—Ä–∫–æ–≤–∫–∞ –¥–≤–æ—Ä–∞</h1>
    <p class="auth-description">
        –ó–¥–µ—Å—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ö–µ–º–∞ –ø–∞—Ä–∫–æ–≤–∫–∏ –Ω–∞—à–µ–≥–æ –¥–≤–æ—Ä–∞. –ú–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å
        –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ (–ø–æ –Ω–æ–º–µ—Ä—É –º–∞—à–∏–Ω–∫–∏) –∏–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –Ω–∏–∂–µ, –∑–∞–Ω–∏–º–∞—Ç—å
        –µ–≥–æ –∏ —É–∫–∞–∑—ã–≤–∞—Ç—å –≤—Ä–µ–º—è —Å—Ç–æ—è–Ω–∫–∏ –∏ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Å–≤—è–∑–∏.
    </p>

    <style>
        .parking-layout {
            margin-top: 12px; /* —Ç–æ–ª—å–∫–æ –æ—Ç—Å—Ç—É–ø, –±–µ–∑ flex */
        }

        .parking-figure {
            margin: 0;
        }

        .parking-figure figcaption {
            font-size: 14px;
            margin-bottom: 6px;
            color: var(--muted-text);
        }

        .parking-figure > img {
            display: block;
            width: 100%;
            max-width: 100%;
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
        }

        .parking-figure-top .parking-image-wrapper {
            position: relative;
        }

        .parking-map-bg {
            display: block;
            width: 100%;
            max-width: 100%;
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
        }

/* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –ü–ê–†–ö–û–í–û–ß–ù–û–ì–û –ú–ï–°–¢–ê (P) ‚Äî –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ */
.parking-hotspot-img {
    display: block;
    width: 100%;
    height: auto;
    border-radius: 12px;
    box-shadow: none;   /* 0 0 0 1px rgba(15, 23, 42, 0.07) —É–±—Ä–∞–ª–∏ —Ç–µ–Ω—å */
    transition:
        box-shadow 0.12s ease,
        opacity 0.12s ease;
}

/* –ú–∞—à–∏–Ω–∫–∞ –º–µ–Ω—å—à–µ —Å–ª–æ—Ç–∞ –∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
.parking-hotspot-car {
    position: absolute;
    left: 50%;
    top: 200%;                                /* —á—É—Ç—å –Ω–∏–∂–µ —Ü–µ–Ω—Ç—Ä–∞, –º–æ–∂–Ω–æ –ø–æ–¥–ø—Ä–∞–≤–∏—Ç—å */
    transform: translate(-50%, -50%);
    width: 80% !important;                   /* –í–û–¢ –ó–î–ï–°–¨ —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç—Å—è —Ä–∞–∑–º–µ—Ä –º–∞—à–∏–Ω–∫–∏ */
    height: auto;
    border-radius: 999px;
    box-shadow: none;
    display: none !important;
    pointer-events: none;
}

/* –µ—Å–ª–∏ –∑–∞–Ω—è—Ç–æ / –Ω–∞–¥–æ–ª–≥–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—à–∏–Ω–∫—É */
.parking-hotspot--occupied .parking-hotspot-car,
.parking-hotspot--long-term .parking-hotspot-car {
    display: block !important;
}


/* –ù–æ–º–µ—Ä –º–∞—à–∏–Ω–∫–∏ –ø–æ–≤–µ—Ä—Ö */
.parking-hotspot-label {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 600;
    /* —Ç—ë–º–Ω—ã–π —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã —á–∏—Ç–∞–ª—Å—è –Ω–∞ —Å–≤–µ—Ç–ª–æ–π –º–∞—à–∏–Ω–µ */
    color: #111827;
    text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
    pointer-events: none;
    /* –¥–ª—è 1‚Äì8 ‚Äî —á—É—Ç—å –Ω–∏–∂–µ —Ü–µ–Ω—Ç—Ä–∞, –±–ª–∏–∂–µ –∫ –æ–∫–Ω—É */
    transform: translateY(9px);
}

/* –æ–±—â–µ–µ –Ω–∞–≤–µ–¥–µ–Ω–∏–µ ‚Äî –º—è–≥–∫–∞—è —Å–∏–Ω—è—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞, –±–µ–∑ –ø–æ–≤–æ—Ä–æ—Ç–∞ */
/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–ª–æ—Ç–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç */
.parking-hotspot:not(.parking-hotspot--occupied):not(.parking-hotspot--long-term):hover
.parking-hotspot-img {
    box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.7);
}

/* –ó–Ω–∞—á–∫–∏-–ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ —Å—Ö–µ–º–µ */
.parking-marker {
    position: absolute;
    border: none;
    padding: 0;
    background: transparent;
    width: 32px;
    height: 32px;
    transform: translate(-50%, -50%);
    cursor: pointer;
    z-index: 5;

    /* —É–±–∏—Ä–∞–µ–º ¬´–∫—Ä—É–≥–ª—É—é –∫–Ω–æ–ø–∫—É¬ª –∏–∑ –±–∞–∑–æ–≤—ã—Ö —Å—Ç–∏–ª–µ–π */
    border-radius: 0;
    box-shadow: none;
}

.parking-marker:focus {
    outline: none;
}

.parking-marker-img {
    display: block;
    width: 100%;
    height: auto;
    border-radius: 0 !important;
    box-shadow: none !important;
    background: transparent;
}

/* —á—Ç–æ–±—ã –º–∞—à–∏–Ω–∫–∏ –±—ã–ª–∏ –ø–æ–≤–µ—Ä—Ö –∑–Ω–∞—á–∫–æ–≤ */
.parking-hotspot {
    position: absolute;
    border: none;
    padding: 0;
    background: transparent;
    width: 65px; /* —Ç–≤–æ–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è */
    height: 30px;
    transform: translate(-50%, -50%);
    cursor: pointer;
    z-index: 10;
}

.parking-hotspot--blocking {
    width: 90px;
    height: 30px;
}

/* –ü–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ 9‚Äì12: –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ú–ê–®–ò–ù–£, –Ω–µ —Å–ª–æ—Ç */
.parking-hotspot--blocking .parking-hotspot-car {
	top: 86%;
    width: 56% !important;   /* –ø–æ–º–µ–Ω—å—à–µ, –ø–æ–¥–≥–æ–Ω–∏ –ø–æ –≤–∫—É—Å—É */
    transform: translate(-50%, -50%) rotate(-90deg) !important;
}

/* –ù–∞–≤–µ–¥–µ–Ω–∏–µ: –ø–æ–≤–æ—Ä–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ–º, –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ —Å–ª–æ—Ç–µ —á–µ—Ä–µ–∑ –æ–±—â–µ–µ –ø—Ä–∞–≤–∏–ª–æ hover */
.parking-hotspot--blocking:hover .parking-hotspot-car {
    transform: rotate(-90deg);
}


/* –¶–∏—Ñ—Ä—ã –Ω–∞ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏—Ö ‚Äî —Å–º–µ—â–∞–µ–º –±–ª–∏–∂–µ –∫ "–∑–∞–¥–Ω–µ–º—É" —Å—Ç–µ–∫–ª—É */
.parking-hotspot--blocking .parking-hotspot-label {
    transform: translate(-35px, 10px);
}


        .parking-spots {
            margin-top: 24px;
            background: var(--card-bg);
            border-radius: 14px;
            border: 1px solid var(--border-color);
            padding: 14px 16px;
        }
        .parking-spots-title {
            margin: 0 0 8px;
            font-size: 16px;
        }
        .parking-spots-note {
            margin: 0 0 12px;
            font-size: 13px;
            color: var(--muted-text);
        }
        .parking-spots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
        }

        .parking-spot-card {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .parking-spot-card-title {
            font-size: 13px;
            color: var(--muted-text-2);
        }

        .parking-spot-btn {
            width: 100%;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            background: var(--chip-bg);
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 32px;
            transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease, box-shadow 0.05s ease;
        }
        .parking-spot-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.2);
        }

        .parking-spot-status {
            display: block;
            line-height: 1.25;
        }

        .parking-spot-btn--free {
            border-color: #22c55e;
            background: rgba(22, 163, 74, 0.1);
            color: #bbf7d0;
        }

        .parking-spot-btn--busy {
            border-color: #3b82f6;
            background: rgba(37, 99, 235, 0.09);
            color: #bfdbfe;
        }

        .parking-spot-btn--long {
            border-color: #020617;
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
        }
		
		/* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞: –¥–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–º */
body:not(.dark-theme) .parking-spot-btn--free { color: #166534; }
body:not(.dark-theme) .parking-spot-btn--busy { color: #1e40af; }


        .parking-spots-group-title {
            font-size: 14px;
            margin: 16px 0 6px;
            color: var(--muted-text-2);
        }

        @media (max-width: 768px) {
            .parking-layout {
                margin-top: 12px;
            }
        }



/* –§—É–ª–ª—Å–∫—Ä–∏–Ω –∫–∞—Ä—Ç–∞ –ø–∞—Ä–∫–æ–≤–∫–∏ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
.parking-layout-fullscreen {
    position: fixed;
    inset: 0;
    z-index: 60;
    background: #020617;
    padding-top: 8px;
    overflow: auto;              /* –¥–∞—ë–º –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å, –Ω–µ —Ä–µ–∂–µ–º –≤—ã—Å–æ—Ç—É */
}

/* –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º —Ñ–∏–≥—É—Ä—É –ø–æ —à–∏—Ä–∏–Ω–µ, –∫–∞–∫ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ */
.parking-layout-fullscreen .parking-figure-top {
    max-width: 100%;
    margin: 0;
}

/* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –≤ —Ä–µ–∂–∏–º–µ "–ö–∞—Ä—Ç–∞" —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –í–°–Æ —Å—Ö–µ–º—É (—Ñ–æ–Ω + –º–∞—à–∏–Ω–∫–∏ + —Ü–∏—Ñ—Ä—ã) */
@media (max-width: 768px) {
    .parking-layout-fullscreen .parking-figure-top {
        max-width: none;
        width: 100%;              /* —Å–∞–º–∞ —Ñ–∏–≥—É—Ä–∞ –≤–æ –≤—Å—é —à–∏—Ä–∏–Ω—É */
    }

    .parking-layout-fullscreen .parking-image-wrapper {
        overflow: visible;
        transform: scale(1.35);   /* —Å—Ç–µ–ø–µ–Ω—å "–∑—É–º–∞" ‚Äî –º–æ–∂–Ω–æ 1.2‚Äì1.5 –ø–æ –≤–∫—É—Å—É */
        transform-origin: top left;
    }
}


/* –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ–º —É image-wrapper –∏ img,
   —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è –ø—Ä–µ–∂–Ω–∏–π –º–∞—Å—à—Ç–∞–± –∏ –ø–æ–∑–∏—Ü–∏–∏ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤ */


/* –ö–Ω–æ–ø–∫–∞ "—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç—É" */
.parking-fullscreen-toggle {
    position: absolute;
    top: 8px;
    left: 8px;
    z-index: 20;
    border: none;
    border-radius: 999px;
    padding: 6px 10px;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: rgba(15, 23, 42, 0.9);
    color: #e5e7eb;
    cursor: pointer;
}

.parking-fullscreen-toggle .icon-collapse {
    display: none;
}

.parking-fullscreen-toggle.is-active .icon-expand {
    display: none;
}

.parking-fullscreen-toggle.is-active .icon-collapse {
    display: inline;
}

/* –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –∫–Ω–æ–ø–∫—É –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º */
@media (min-width: 769px) {
    .parking-fullscreen-toggle {
        display: none;
    }
}

/* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è 1‚Äì8 –∏ 9‚Äì12 */
@media (max-width: 640px) {
    /* —Å–ª–æ—Ç 1‚Äì8 */
    .parking-hotspot {
        width: 27px;
        height: 13px;
    }

    /* —Å–ª–æ—Ç 9‚Äì12 ‚Äî —á—É—Ç—å –¥–ª–∏–Ω–Ω–µ–µ –∏ —à–∏—Ä–µ */
    .parking-hotspot.parking-hotspot--blocking {
        width: 34px;
        height: 16px;
    }

    /* –º–∞—à–∏–Ω–∫–∞ 1‚Äì8 ‚Äî –º–µ–Ω—å—à–µ –∏ –±–ª–∏–∂–µ –∫ —Ü–µ–Ω—Ç—Ä—É —Å–ª–æ—Ç–∞ */
    .parking-hotspot-car {
        top: 175%;
        width: 65% !important;
    }

    /* –º–∞—à–∏–Ω–∫–∞ 9‚Äì12 ‚Äî –µ—â—ë –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –∏ —á—É—Ç—å –≤—ã—à–µ */
    .parking-hotspot.parking-hotspot--blocking .parking-hotspot-car {
        top: 75%;
        width: 50% !important;
    }

    /* —Ü–∏—Ñ—Ä—ã —á—É—Ç—å –ø–æ–º–µ–Ω—å—à–µ –∏ –ø–æ–Ω–∏–∂–µ */
    .parking-hotspot-label {
        font-size: 9px;
        transform: translateY(4px);
    }
	    /* –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–π —Ü–∏—Ñ—Ä—ã 9‚Äì12 –ø–æ–¥–Ω–∏–º–∞–µ–º —á—É—Ç—å –≤—ã—à–µ */
    .parking-hotspot.parking-hotspot--blocking .parking-hotspot-label {
        transform: translate(-11px, 4px);
    }

	/* ‚Üì‚Üì‚Üì —É–º–µ–Ω—å—à–µ–Ω–∏–µ –∑–Ω–∞—á–∫–æ–≤ –Ω–∞ –º–æ–±–∏–ª–∫–µ ‚Üì‚Üì‚Üì */
    .parking-marker {
        width: 14px;
        height: 14px;
    }

    .parking-marker-img {
        width: 100%;
        height: auto;
    }
}


        /* –ú–æ–¥–∞–ª–∫–∞ */

        .parking-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            padding: 16px;
        }

        .parking-modal-backdrop.is-open {
            display: flex;
        }

        .parking-modal {
            max-width: 380px;
            width: 100%;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px 18px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
            font-size: 14px;
        }

        .parking-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .parking-modal-title {
            margin: 0;
            font-size: 16px;
        }

        .parking-modal-close {
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0 4px;
        }

        .parking-modal-body {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .parking-modal-row {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
/* –°—Ç—Ä–æ–∫–∞ "–°—Ç–∞—Ç—É—Å: ..." –≤ –æ–¥–Ω—É –ª–∏–Ω–∏—é */
.parking-modal-row.parking-modal-row-inline {
    display: flex;
    flex-direction: row; /* <-- –í–ê–ñ–ù–û: –ø–µ—Ä–µ–±–∏–≤–∞–µ–º column */
    align-items: center;
    justify-content: flex-start;
    gap: 12px;
}

.parking-modal-status-inline {
    text-align: right;
    white-space: nowrap;
}

        .parking-modal-owner-photo {
            margin-top: 6px;
        }

        .parking-modal-owner-photo img {
            max-width: 100%;
            border-radius: 8px;
            display: block;
            cursor: pointer;
        }

        .parking-modal-label {
            font-size: 12px;
            color: var(--muted-text);
        }

        .parking-modal-input,
        .parking-modal-input[type="datetime-local"] {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 6px 8px;
            background: transparent;
            color: var(--text-color);
            font-size: 13px;
        }

        .parking-modal-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(75, 107, 255, 0.2);
        }

        .parking-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 4px;
        }

        .parking-btn {
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid transparent;
            background: var(--chip-bg);
        }

        .parking-btn-primary {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
        }

        .parking-btn-primary:hover {
            background: var(--accent-hover);
        }

        .parking-btn-secondary {
    border-color: var(--border-color);
    color: var(--text-color);
    background: transparent;
}

.parking-btn-secondary:hover {
    background: var(--nav-hover-bg);
}


        .parking-btn-danger {
            border-color: #b91c1c;
            color: #fee2e2;
            background: #7f1d1d;
        }

        .parking-modal-hint {
            font-size: 12px;
            color: var(--muted-text-2);
        }
/* --- –ü–æ–∑–≤–æ–Ω–∏—Ç—å + —Ç–∞–π–º–µ—Ä –¥–æ –∫–æ–Ω—Ü–∞ –±—Ä–æ–Ω–∏ (–≤ –º–æ–¥–∞–ª–∫–µ) --- */
.parking-call-link{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  margin-left:8px;
  width:28px;
  height:28px;
  border-radius:999px;
  background: rgba(34,197,94,0.15);
  border: 1px solid rgba(34,197,94,0.35);
  text-decoration:none;
  font-size:16px;
  line-height:1;
}
.parking-call-link:hover{ background: rgba(34,197,94,0.25); }
.parking-call-link span{ color:#22c55e; }

.parking-until-row{
  display:flex;
  align-items:center;
  gap:8px;
}
.parking-until-countdown{
  margin-left:auto;
  font-variant-numeric: tabular-nums;
  font-weight:600;
  opacity:0.9;
  background: rgba(148,163,184,0.12);
  border:1px solid rgba(148,163,184,0.25);
  border-radius:999px;
  padding:3px 10px;
}
/* –ù–∞ –º–æ–±–∏–ª–∫–µ –≤–º–µ—Å—Ç–æ "–û—Å—Ç–∞–ª–æ—Å—å:" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É ‚è≥ */
@media (max-width: 520px) {
  .parking-until-left {
    font-size: 0; /* –ø—Ä—è—á–µ–º —Ç–µ–∫—Å—Ç */
  }
  .parking-until-left::before {
    content: "‚è≥";
    font-size: 14px;
    line-height: 1;
  }
}

.parking-clock-icon{ opacity:0.9; }

        .parking-modal-error {
            font-size: 12px;
            color: #f87171;
            display: none;
        }

        .parking-modal-error.is-visible {
            display: block;
        }
		

/* –ó–∞–Ω—è—Ç–æ / –Ω–∞–¥–æ–ª–≥–æ ‚Äî –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ú–ê–®–ò–ù–ö–£ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.parking-hotspot--occupied:hover .parking-hotspot-car,
.parking-hotspot--occupied-other:hover .parking-hotspot-car {
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.95) !important;
}

.parking-hotspot--long-term:hover .parking-hotspot-car {
    box-shadow:
        0 0 0 1px #3b2f2a,
        0 0 0 3px rgba(75, 56, 35, 0.45) !important;
}
.parking-modal-owner-photo {
    margin-top: 8px;
}

.guest-pending-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.65);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 6000;
  padding: 16px;
}
.guest-pending-overlay.is-open{ display:flex; }

.guest-pending-card{
  width: min(560px, 100%);
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 18px;
  padding: 16px;
  box-shadow: var(--shadow-soft);
}
.guest-pending-title{ margin: 0 0 8px 0; }
.guest-pending-text{ margin: 6px 0; opacity: .92; }
.guest-pending-status{ margin-top: 10px; opacity: .85; }
.guest-pending-status-row{
  margin-top: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

/* —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–π margin-top —É .guest-pending-status –Ω–µ –ª–æ–º–∞–ª –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫–µ */
.guest-pending-status-row .guest-pending-status{
  margin-top: 0;
}

    </style>

    <!-- –í–ï–†–•–ù–Ø–Ø –ö–ê–†–¢–ê (–≤–æ –≤—Å—é —à–∏—Ä–∏–Ω—É —Å–µ–∫—Ü–∏–∏) -->
    <div class="parking-layout">
        <figure class="parking-figure parking-figure-top">
            <figcaption>–°—Ö–µ–º–∞ –ø–∞—Ä–∫–æ–≤–∫–∏ ‚Äî –ø–µ—Ä–µ–¥ –ø–æ–¥—ä–µ–∑–¥–∞–º–∏</figcaption>
            <div class="parking-image-wrapper">

                <!-- –ö–Ω–æ–ø–∫–∞ —Ñ—É–ª–ª—Å–∫—Ä–∏–Ω–∞ –∫–∞—Ä—Ç—ã (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª–∫–µ) -->
                <button type="button"
                        id="parkingFullscreenToggle"
                        class="parking-fullscreen-toggle"
                        aria-pressed="false">
                    <span class="icon-expand">‚§¢</span>
                    <span class="icon-collapse">‚úï</span>
                    Zoom
                </button>

                <!-- –§–æ–Ω –∫–∞—Ä—Ç—ã -->
                <img src="{{ url_for('static', filename='img/parking_top.png') }}"
                     alt="–°—Ö–µ–º–∞ –ø–∞—Ä–∫–æ–≤–∫–∏, –≤–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å"
                     class="parking-map-bg">

                <!-- –ó–Ω–∞—á–∫–∏-–ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
                <!-- –∫—Ä–µ—Å—Ç–∏–∫–∏: "–Ω–µ –ø–∞—Ä–∫—É–µ–º—Å—è" -->
                <button
                    class="parking-marker"
                    data-message="–í –¥–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –Ω–µ –ø–∞—Ä–∫—É–µ–º—Å—è, —á—Ç–æ–± –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ!"
                    style="top: 24%; left: 25.5%;">
                    <img src="{{ url_for('static', filename='img/parking_sign_nopark.png') }}"
                         alt="–ó–¥–µ—Å—å –Ω–µ –ø–∞—Ä–∫—É–µ–º—Å—è"
                         class="parking-marker-img">
                </button>

                <button
                    class="parking-marker"
                    data-message="–í –¥–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –Ω–µ –ø–∞—Ä–∫—É–µ–º—Å—è, —á—Ç–æ–± –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ!"
                    style="top: 70%; left: 22%;">
                    <img src="{{ url_for('static', filename='img/parking_sign_nopark.png') }}"
                         alt="–ó–¥–µ—Å—å –Ω–µ –ø–∞—Ä–∫—É–µ–º—Å—è"
                         class="parking-marker-img">
                </button>

                <button
                    class="parking-marker"
                    data-message="–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø–∞—Ä–∫—É–π—Ç–µ—Å—å –≤ –¥–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö!"
                    style="top: 67%; left: 7%;">
                    <img src="{{ url_for('static', filename='img/parking_sign_warning.png') }}"
                         alt="–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø–∞—Ä–∫—É–π—Ç–µ—Å—å"
                         class="parking-marker-img">
                </button>

                <!-- –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ: "–≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø–∞—Ä–∫—É–µ–º—Å—è" -->
                <button
                    class="parking-marker"
                    data-message="–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø–∞—Ä–∫—É–π—Ç–µ—Å—å –≤ –¥–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö"
                    style="top: 40%; left: 25%;">
                    <img src="{{ url_for('static', filename='img/parking_sign_warning.png') }}"
                         alt="–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø–∞—Ä–∫—É–π—Ç–µ—Å—å"
                         class="parking-marker-img">
                </button>

                <button
                    class="parking-marker"
                    data-message="–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø–∞—Ä–∫—É–π—Ç–µ—Å—å –≤ –¥–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö"
                    style="top: 29%; left: 74%;">
                    <img src="{{ url_for('static', filename='img/parking_sign_warning.png') }}"
                         alt="–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø–∞—Ä–∫—É–π—Ç–µ—Å—å"
                         class="parking-marker-img">
                </button>

                <!-- –û–±—ã—á–Ω—ã–µ –º–µ—Å—Ç–∞ 1‚Äì8 -->
                <button class="parking-hotspot"
                        data-spot-id="1" data-spot-label="1" data-spot-type="regular"
                        style="top: 24%; left: 21.2%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="–ú–µ—Å—Ç–æ 1"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 1"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">1</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="2" data-spot-label="2" data-spot-type="regular"
                        style="top: 18%; left: 30.1%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="–ú–µ—Å—Ç–æ 2"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 2"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">2</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="3" data-spot-label="3" data-spot-type="regular"
                        style="top: 18%; left: 36%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="–ú–µ—Å—Ç–æ 3"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 3"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">3</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="4" data-spot-label="4" data-spot-type="regular"
                        style="top: 18%; left: 41.9%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="–ú–µ—Å—Ç–æ 4"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 4"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">4</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="5" data-spot-label="5" data-spot-type="regular"
                        style="top: 18%; left: 49.8%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="–ú–µ—Å—Ç–æ 5"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 5"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">5</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="6" data-spot-label="6" data-spot-type="regular"
                        style="top: 18%; left: 55.8%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="–ú–µ—Å—Ç–æ 6"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 6"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">6</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="7" data-spot-label="7" data-spot-type="regular"
                        style="top: 18%; left: 62%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="–ú–µ—Å—Ç–æ 7"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 7"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">7</span>
                </button>

                <button class="parking-hotspot"
                        data-spot-id="8" data-spot-label="8" data-spot-type="regular"
                        style="top: 18%; left: 68%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_regular.png') }}"
                         alt="–ú–µ—Å—Ç–æ 8"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_regular.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 8"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">8</span>
                </button>

                <!-- –ü–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ –º–µ—Å—Ç–∞ 9‚Äì12 -->
                <button class="parking-hotspot parking-hotspot--blocking"
                        data-spot-id="9" data-spot-label="9" data-spot-type="blocking"
                        style="top: 40%; left: 35%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_blocking.png') }}"
                         alt="–ú–µ—Å—Ç–æ 9"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_blocking.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 9"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">9</span>
                </button>

                <button class="parking-hotspot parking-hotspot--blocking"
                        data-spot-id="10" data-spot-label="10" data-spot-type="blocking"
                        style="top: 40%; left: 48%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_blocking.png') }}"
                         alt="–ú–µ—Å—Ç–æ 10"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_blocking.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 10"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">10</span>
                </button>

                <button class="parking-hotspot parking-hotspot--blocking"
                        data-spot-id="11" data-spot-label="11" data-spot-type="blocking"
                        style="top: 40%; left: 62%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_blocking.png') }}"
                         alt="–ú–µ—Å—Ç–æ 11"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_blocking.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 11"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">11</span>
                </button>

                <button class="parking-hotspot parking-hotspot--blocking"
                        data-spot-id="12" data-spot-label="12" data-spot-type="blocking"
                        style="top: 40%; left: 75%;">
                    <img src="{{ url_for('static', filename='img/parking_slot_blocking.png') }}"
                         alt="–ú–µ—Å—Ç–æ 12"
                         class="parking-hotspot-img">
                    <img src="{{ url_for('static', filename='img/parking_car_blocking.png') }}"
                         alt="–ê–≤—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ 12"
                         class="parking-hotspot-car">
                    <span class="parking-hotspot-label">12</span>
                </button>

            </div>

        </figure>
    </div>

    <!-- –ë–õ–û–ö –° –ú–ï–°–¢–ê–ú–ò -->
    <div class="parking-spots">
        <h2 class="parking-spots-title">–ú–µ—Å—Ç–∞ –Ω–∞ –ø–∞—Ä–∫–æ–≤–∫–µ</h2>
        <p class="parking-spots-note">
            –ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å –Ω–∞ –º–∞—à–∏–Ω–∫—É –Ω–∞ —Å—Ö–µ–º–µ –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ –≤ —Å–ø–∏—Å–∫–µ –Ω–∏–∂–µ.
            –ó–∞–Ω—è—Ç–æ–µ –º–µ—Å—Ç–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è, –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–∏–¥–Ω–æ, –∫—Ç–æ –∏ –¥–æ –∫–∞–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç–∞–º —Å—Ç–æ–∏—Ç.
        </p>

        {% set regular = spots | selectattr('id', 'in', [1,2,3,4,5,6,7,8]) | list %}
        {% set blocking = spots | selectattr('type', 'equalto', 'blocking') | list %}

        {% if regular %}
            <div>
                <div class="parking-spots-group-title">–û–±—ã—á–Ω—ã–µ –º–µ—Å—Ç–∞ (1‚Äì8)</div>
                <div class="parking-spots-grid">
                    {% for spot in regular %}
                        <div class="parking-spot-card">
                            <div class="parking-spot-card-title">–ú–µ—Å—Ç–æ {{ spot.label }}</div>
                            <button
                                type="button"
                                class="parking-spot-btn"
                                data-spot-id="{{ spot.id }}"
                                data-spot-label="{{ spot.label }}"
                                data-spot-type="regular"
                            >
                                <span class="parking-spot-status" data-role="spot-status">–ú–æ–∂–Ω–æ –∑–∞–Ω—è—Ç—å</span>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {% if blocking %}
            <div>
                <div class="parking-spots-group-title">–ü–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ (9‚Äì12, —Ç–µ–ª–µ—Ñ–æ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)</div>
                <div class="parking-spots-grid">
                    {% for spot in blocking %}
                        <div class="parking-spot-card">
                            <div class="parking-spot-card-title">–ú–µ—Å—Ç–æ {{ spot.label }}</div>
                            <button
                                type="button"
                                class="parking-spot-btn"
                                data-spot-id="{{ spot.id }}"
                                data-spot-label="{{ spot.label }}"
                                data-spot-type="blocking"
                            >
                                <span class="parking-spot-status" data-role="spot-status">–ú–æ–∂–Ω–æ –∑–∞–Ω—è—Ç—å</span>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>

    <!-- –ù–ò–ñ–ù–Ø–Ø –ö–ê–†–¢–ê –ü–û–î –°–ü–ò–°–ö–û–ú –ú–ï–°–¢ -->
    <figure class="parking-figure" style="margin-top: 24px;">
        <figcaption>–°—Ö–µ–º–∞ –ø–∞—Ä–∫–æ–≤–∫–∏ - –ø–æ–∑–∞–¥–∏ –¥–æ–º–∞</figcaption>
        <img src="{{ url_for('static', filename='img/parking_bottom.png') }}"
             alt="–°—Ö–µ–º–∞ –ø–∞—Ä–∫–æ–≤–∫–∏, –Ω–∏–∂–Ω—è—è —á–∞—Å—Ç—å">
    </figure>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–µ—Å—Ç–∞ -->
    <div class="parking-modal-backdrop" id="parkingModal">
        <div class="parking-modal">
            <div class="parking-modal-header">
                <h2 class="parking-modal-title" id="parkingModalTitle">–ú–µ—Å—Ç–æ</h2>
                <button class="parking-modal-close" type="button" data-role="close-modal">&times;</button>
            </div>
            <div class="parking-modal-body">
                <div class="parking-modal-row parking-modal-row-inline">
                    <div class="parking-modal-label">
                        –°—Ç–∞—Ç—É—Å ‚Äî <span id="parkingModalStatus" class="parking-modal-hint parking-modal-status-inline">–°–≤–æ–±–æ–¥–Ω–æ</span>
                    </div>
                </div>

                <!-- —Ñ–ª–∞–≥ "–Ω–∞–¥–æ–ª–≥–æ" ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
                <div class="parking-modal-row parking-modal-editable" id="parkingLongRow">
                    <label class="parking-modal-label" for="parkingLongTerm">
                        <input type="checkbox" id="parkingLongTerm">
                        –ù–∞–¥–æ–ª–≥–æ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å)
                    </label>
                    <div class="parking-modal-hint">
                        –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∏–¥—è—Ç, —á—Ç–æ –º–∞—à–∏–Ω–∞ —Å—Ç–æ–∏—Ç –∑–¥–µ—Å—å –Ω–∞–¥–æ–ª–≥–æ.
                    </div>
                </div>

                <div class="parking-modal-row parking-modal-editable">
                    <label class="parking-modal-label" for="parkingUntil">
                        –î–æ –∫–∞–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —Å—Ç–æ—è—Ç—å? (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                    </label>
                    <input
                        type="datetime-local"
                        id="parkingUntil"
                        class="parking-modal-input"
                        autocomplete="off"
                    >
                    <div class="parking-modal-hint">
                        –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ Enter –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –≤–Ω–µ –ø–æ–ª—è, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å.
                    </div>
                </div>

                <div class="parking-modal-row parking-modal-editable">
                    <label class="parking-modal-label" for="parkingCarCode">
                        –ù–æ–º–µ—Ä –º–∞—à–∏–Ω—ã (3 —Ü–∏—Ñ—Ä—ã –∏–ª–∏ –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä)
                    </label>
                    <input
                        type="text"
                        id="parkingCarCode"
                        class="parking-modal-input"
                        placeholder="418 –∏–ª–∏ –ê777–ï–¢197"
                    >
                </div>

                <div class="parking-modal-row parking-modal-editable">
                    <label class="parking-modal-label" for="parkingPhone">
                        –¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏ (–¥–ª—è –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏—Ö –º–µ—Å—Ç)
                    </label>
                    <input type="tel" id="parkingPhone" class="parking-modal-input" placeholder="+7 900 000-00-00">
                    <label class="parking-modal-label">
                        <input type="checkbox" id="parkingShowPhone" checked>
                        –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω —Å–æ—Å–µ–¥—è–º –Ω–∞ —ç—Ç–æ–º –º–µ—Å—Ç–µ
                    </label>
                </div>

                <div class="parking-modal-row">
                    <div class="parking-modal-label">
                        –¢–µ–∫—É—â–∏–π –≤–ª–∞–¥–µ–ª–µ—Ü ‚Äî <span id="parkingModalOwnerTop" class="parking-modal-hint">‚Äî</span>
                    </div>

                    <div id="parkingModalOwnerBottom" class="parking-modal-hint"></div>
                    <div id="parkingModalOwnerNote" class="parking-modal-hint"></div>
                </div>

				<!-- –§–æ—Ç–æ –º–∞—à–∏–Ω—ã –≥–æ—Å—Ç—è, –µ—Å–ª–∏ –µ—Å—Ç—å -->
<div id="parkingModalOwnerPhoto" style="display: none; margin-top: 4px;">
    <a id="parkingModalOwnerPhotoLink" href="#" target="_blank">
        <img
            id="parkingModalOwnerPhotoImg"
            src=""
            alt="–§–æ—Ç–æ –º–∞—à–∏–Ω—ã –≥–æ—Å—Ç—è"
            style="max-width: 100%; border-radius: 8px; display: block;"
        >
    </a>
</div>



                <div id="parkingModalError" class="parking-modal-error"></div>
            </div>
<div class="parking-modal-footer">
    <button type="button" class="parking-btn parking-btn-secondary" data-role="cancel-modal">
        –ó–∞–∫—Ä—ã—Ç—å
    </button>

    <!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ -->
    <button
        type="button"
        class="parking-btn parking-btn-secondary"
        id="parkingSubscribeBtn"
        style="display: none;"
    >
        –û–ø–æ–≤–µ—Å—Ç–∏—Ç—å, –∫–æ–≥–¥–∞ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è
    </button>

    <button type="button" class="parking-btn parking-btn-danger parking-modal-editable" id="parkingFreeBtn" style="display:none;">
        –û—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ
    </button>
    <button type="button" class="parking-btn parking-btn-primary parking-modal-editable" id="parkingSaveBtn">
        –ó–∞–Ω—è—Ç—å –º–µ—Å—Ç–æ
    </button>
</div>

        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const root = document.getElementById("parking-root");
            const userApartment = (root.dataset.userApartment || "").trim();
            const isAdmin = root.dataset.userIsAdmin === "1";
            const userPhone = (root.dataset.userPhone || "").trim();
            const userCarNumber = (root.dataset.userCarNumber || "").trim();
			const canSubscribe = root.dataset.userCanSubscribe === "1";
			const isGuest = root.dataset.userIsGuest === "1";
let guestStatus = (root.dataset.userGuestStatus || "").trim().toLowerCase();

const guestOverlay = document.getElementById("guestPendingOverlay");
const guestStatusEl = document.getElementById("guestPendingStatus");
const guestCheckBtn = document.getElementById("guestPendingCheckBtn");

function setGuestOverlayVisible(visible){
  if (!guestOverlay) return;
  if (visible){
    guestOverlay.classList.add("is-open");
    guestOverlay.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  } else {
    guestOverlay.classList.remove("is-open");
    guestOverlay.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }
}

let guestStatusTimer = null;

async function pollGuestApproval(){
  if (!isGuest) return;

  try{
    const r = await fetch("/api/guest/status", {
      headers: { "X-Requested-With":"XMLHttpRequest" }
    });
    const d = await r.json().catch(()=> ({}));

    if (!r.ok || !d.ok){
      if (guestStatusEl) guestStatusEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
      setGuestOverlayVisible(true);
      return;
    }

    const st = String(d.status || "pending").toLowerCase();
    guestStatus = st;

    const rej = document.getElementById("guestPendingRejected");

    if (st === "approved"){
      if (rej) rej.style.display = "none";
      setGuestOverlayVisible(false);

      await fetchSpotsAndRefresh();

      if (guestStatusTimer){
        clearInterval(guestStatusTimer);
        guestStatusTimer = null;
      }
      return;
    }

    if (st === "rejected"){
      if (guestStatusEl) guestStatusEl.textContent = "–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.";
      if (rej) rej.style.display = "block";
      setGuestOverlayVisible(true);
      return;
    }

    // pending / unknown
    if (guestStatusEl) guestStatusEl.textContent = "–û–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞‚Ä¶";
    if (rej) rej.style.display = "none";
    setGuestOverlayVisible(true);

  } catch(e){
    if (guestStatusEl) guestStatusEl.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞.";
    setGuestOverlayVisible(true);
  }
}

// –≤–∫–ª—é—á–∞–µ–º –æ–≤–µ—Ä–ª–µ–π —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –≥–æ—Å—Ç—å –∏ –Ω–µ approved
if (isGuest && guestStatus !== "approved") {
  setGuestOverlayVisible(true);
  pollGuestApproval();
  guestStatusTimer = setInterval(pollGuestApproval, 15000);
}
if (guestCheckBtn) {
  guestCheckBtn.addEventListener("click", async () => {
    if (guestStatusEl) guestStatusEl.textContent = "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å‚Ä¶";
    await pollGuestApproval();
  });
}

            const modalBackdrop = document.getElementById("parkingModal");
            const modalTitle = document.getElementById("parkingModalTitle");
            const modalStatus = document.getElementById("parkingModalStatus");
            const modalOwnerTop = document.getElementById("parkingModalOwnerTop");
            const modalOwnerBottom = document.getElementById("parkingModalOwnerBottom");
            const modalOwnerNote = document.getElementById("parkingModalOwnerNote");

            const modalError = document.getElementById("parkingModalError");


            // –±–ª–æ–∫ —Å —Ñ–æ—Ç–æ + —Å—Å—ã–ª–∫–∞ + —Å–∞–º–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞
            const modalOwnerPhotoBox  = document.getElementById("parkingModalOwnerPhoto");
            const modalOwnerPhotoLink = document.getElementById("parkingModalOwnerPhotoLink");
            const modalOwnerPhotoImg  = document.getElementById("parkingModalOwnerPhotoImg");

            const inputUntil = document.getElementById("parkingUntil");
            const inputCarCode = document.getElementById("parkingCarCode");
            const inputPhone = document.getElementById("parkingPhone");
            const inputShowPhone = document.getElementById("parkingShowPhone");
            const inputLongTerm = document.getElementById("parkingLongTerm");
            const longRow = document.getElementById("parkingLongRow");
            const btnSave = document.getElementById("parkingSaveBtn");
            const btnFree = document.getElementById("parkingFreeBtn");
			const btnSubscribe = document.getElementById("parkingSubscribeBtn");
            const editableRows = document.querySelectorAll(".parking-modal-editable");

            let currentSpotId = null;
            let currentSpotType = null;
            let currentSpotData = null;

            // –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ –∫–ª–∏–∫—É –Ω–∞ –ø–æ–ª–µ
            if (inputUntil && typeof inputUntil.showPicker === "function") {
                const openPicker = () => inputUntil.showPicker();
                inputUntil.addEventListener("click", openPicker);
                inputUntil.addEventListener("focus", openPicker);
            }
let untilCountdownTimer = null;

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function normalizeTelHref(phone){
  const s = String(phone || "").trim();
  const cleaned = s.replace(/[^\d+]/g, "");
  return cleaned || s;
}

function parseIsoLocal(untilStr){
  const m = /^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2})/.exec(String(untilStr || ""));
  if (!m) return null;
  const dt = new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], 0, 0);
  if (Number.isNaN(dt.getTime())) return null;
  return dt;
}

function formatDateTimeRu(untilStr){
  const dt = parseIsoLocal(untilStr);
  if (!dt) return null;
  const dd = String(dt.getDate()).padStart(2,"0");
  const mm = String(dt.getMonth()+1).padStart(2,"0");
  const yyyy = dt.getFullYear();
  const hh = String(dt.getHours()).padStart(2,"0");
  const mi = String(dt.getMinutes()).padStart(2,"0");
  return { date:`${dd}.${mm}.${yyyy}`, time:`${hh}:${mi}`, ts: dt.getTime() };
}

function stopUntilCountdown(){
  if (untilCountdownTimer){
    clearInterval(untilCountdownTimer);
    untilCountdownTimer = null;
  }
}

function startUntilCountdown(untilStr){
  stopUntilCountdown();
  const parts = formatDateTimeRu(untilStr);
  if (!parts) return;
  const el = document.getElementById("parkingUntilCountdown");
  if (!el) return;

  function tick(){
    const diff = parts.ts - Date.now();
    if (diff <= 0){
      el.textContent = "00:00";
      stopUntilCountdown();
      return;
    }
    const totalMin = Math.max(0, Math.ceil(diff / 60000));
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    el.textContent = `${h}:${String(m).padStart(2, "0")}`;
  }

  tick();
  untilCountdownTimer = setInterval(tick, 15000);
}

            function formatUntilText(untilStr) {
                if (!untilStr) {
                    return "–ó–∞–Ω—è—Ç–æ";
                }
                const dt = new Date(untilStr);
                if (isNaN(dt.getTime())) {
                    return "–ó–∞–Ω—è—Ç–æ";
                }

                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const target = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
                const diffDays = Math.round((target - today) / 86400000);

                const timeStr = dt.toLocaleTimeString("ru-RU", {
                    hour: "2-digit",
                    minute: "2-digit"
                });

                let dayPart;
                if (diffDays === 0) {
                    dayPart = "—Å–µ–≥–æ–¥–Ω—è";
                } else if (diffDays === 1) {
                    dayPart = "–∑–∞–≤—Ç—Ä–∞";
                } else if (diffDays === 2) {
                    dayPart = "–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞";
                } else {
                    const d = String(dt.getDate()).padStart(2, "0");
                    const m = String(dt.getMonth() + 1).padStart(2, "0");
                    const y = dt.getFullYear();
                    dayPart = `${d}.${m}.${y}`;

                }

                return `–ó–∞–Ω—è—Ç–æ –¥–æ ${dayPart} üïí ${timeStr}`;
            }

            function openModalForSpot(el, spotData) {
                currentSpotId = parseInt(el.dataset.spotId, 10);
                currentSpotType = el.dataset.spotType;
                currentSpotData = spotData || null;

                modalError.classList.remove("is-visible");
                modalError.textContent = "";

                const label = el.dataset.spotLabel;
                modalTitle.textContent = `–ú–µ—Å—Ç–æ ${label}`;

                const occ = spotData && spotData.occupied && spotData.occupant ? spotData.occupant : null;
                const longTerm = occ && occ.long_term;

               if (occ) {
    let who;

    if (
        occ.is_guest ||
        (occ.apartment && String(occ.apartment).toLowerCase() === "–≥–æ—Å—Ç—å") ||
        (occ.apartment && /^g\d+$/i.test(String(occ.apartment)))
    ) {
        const guestName = (occ.name || "").trim();
        who = guestName ? `–ì–æ—Å—Ç—å ${guestName}` : "–ì–æ—Å—Ç—å";
    } else if (occ.apartment) {
        who = `–ö–≤. ${occ.apartment}`;
    } else {
        who = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
    }

    const car = (occ.car_code || occ.car_number || "").trim();
    const phone = (occ.phone || "").trim();

    // --- –°–¢–ê–¢–£–° (—Å —Ç–∞–π–º–µ—Ä–æ–º —Å–ø—Ä–∞–≤–∞) ---
    if (longTerm) {
        stopUntilCountdown();
        modalStatus.textContent = "–ó–∞–Ω—è—Ç–æ (–Ω–∞–¥–æ–ª–≥–æ)";
    } else if (occ.until) {
modalStatus.innerHTML =
  `<div class="parking-until-row">` +
  `<span>${escapeHtml(formatUntilText(occ.until))}</span>` +
  `<span class="parking-until-left">–û—Å—Ç–∞–ª–æ—Å—å:</span>` +
  `<span id="parkingUntilCountdown" class="parking-until-countdown"></span>` +
  `</div>`;

        startUntilCountdown(occ.until);
    } else {
        stopUntilCountdown();
        modalStatus.textContent = "–ó–∞–Ω—è—Ç–æ";
    }

    // --- –í–õ–ê–î–ï–õ–ï–¶ (—Ç–µ–ª–µ—Ñ–æ–Ω + –∫–Ω–æ–ø–∫–∞ –∑–≤–æ–Ω–∫–∞ üìû) ---
    const phoneText = phone ? `, —Ç–µ–ª. ${escapeHtml(phone)}` : "";
    const carText = car ? `, –∞–≤—Ç–æ ${escapeHtml(car)}` : "";
    const callBtn = phone
        ? ` <a class="parking-call-link" href="tel:${escapeHtml(normalizeTelHref(phone))}" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å"><span>üìû</span></a>`
        : "";

    if (modalOwnerTop) {
    modalOwnerTop.textContent = car ? `${who}, –∞–≤—Ç–æ ${car}` : `${who}`;
}
if (modalOwnerBottom) {
    modalOwnerBottom.innerHTML = phone
        ? `–¢–µ–ª. ${escapeHtml(phone)}${callBtn}`
        : "";
}
if (modalOwnerNote) {
    modalOwnerNote.textContent = ""; // —Å—é–¥–∞ –Ω–∏–∂–µ –ø–æ–ª–æ–∂–∏–º —Ç–µ–∫—Å—Ç –ø—Ä–æ –ø—Ä–∞–≤–∞
}

} else {
    stopUntilCountdown();
    modalStatus.textContent = "–°–≤–æ–±–æ–¥–Ω–æ";
    if (modalOwnerTop) modalOwnerTop.textContent = "‚Äî";
    if (modalOwnerBottom) modalOwnerBottom.textContent = "–ú–µ—Å—Ç–æ —Å–≤–æ–±–æ–¥–Ω–æ.";
    if (modalOwnerNote) modalOwnerNote.textContent = "";
}

// –ø–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ –≥–æ—Å—Ç—è
if (modalOwnerPhotoBox && modalOwnerPhotoImg && modalOwnerPhotoLink) {
    if (
    occ &&
    (
        occ.is_guest ||
        (occ.apartment && /^g\d+$/i.test(String(occ.apartment))) ||
        (occ.apartment && String(occ.apartment).toLowerCase() === "–≥–æ—Å—Ç—å")
    ) &&
    occ.guest_photo
) {

        let src = occ.guest_photo;

        // –µ—Å–ª–∏ –ø—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º /static/
        if (src && !src.startsWith("http")) {
            src = "/static/" + src.replace(/^\/+/, "");
        }

        modalOwnerPhotoImg.src = src;
        modalOwnerPhotoImg.alt = "–§–æ—Ç–æ –º–∞—à–∏–Ω—ã –≥–æ—Å—Ç—è";
        modalOwnerPhotoLink.href = src;

        modalOwnerPhotoBox.style.display = "block";
    } else {
        // —Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫, –µ—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç –∏–ª–∏ —ç—Ç–æ –Ω–µ –≥–æ—Å—Ç—å
        modalOwnerPhotoImg.src = "";
        modalOwnerPhotoLink.href = "#";
        modalOwnerPhotoBox.style.display = "none";
    }
}



                const occupiedByMe = !!(occ && occ.apartment === userApartment);
                const occupied = !!occ;
                const readOnly = occupied && !occupiedByMe && !isAdmin;
				
				// –ø–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ–¥–ø–∏—Å–∫–∏
if (btnSubscribe) {
    if (canSubscribe && occupied && !occupiedByMe) {
        // –º–µ—Å—Ç–æ –∑–∞–Ω—è—Ç–æ –Ω–µ –º–Ω–æ–π, –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
        btnSubscribe.style.display = "inline-block";
        btnSubscribe.disabled = false;
    } else {
        btnSubscribe.style.display = "none";
    }
}


                // –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è
                editableRows.forEach((row) => {
                    row.style.display = readOnly ? "none" : (row.tagName === "BUTTON" ? "inline-block" : "flex");
                });

                // –≥–∞–ª–æ—á–∫–∞ "–Ω–∞–¥–æ–ª–≥–æ": –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É
                if (isAdmin && !readOnly) {
                    longRow.style.display = "flex";
                    inputLongTerm.disabled = false;
                    inputLongTerm.checked = !!longTerm;
                } else {
                    longRow.style.display = "none";
                    inputLongTerm.checked = !!longTerm;
                }

                // –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
inputUntil.value = "";
inputCarCode.value = "";
inputPhone.value = "";
inputShowPhone.checked = true;

// –µ—Å–ª–∏ –º–µ—Å—Ç–æ —É–∂–µ –∑–∞–Ω—è—Ç–æ ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞
if (occ) {
    if (occ.until) inputUntil.value = occ.until.slice(0, 16); // datetime-local
    const occCarLabel = (occ.car_code || occ.car_number || "").trim();
	if (occCarLabel) inputCarCode.value = occCarLabel;
    if (occ.phone) inputPhone.value = occ.phone;
    inputShowPhone.checked = Boolean(occ.show_phone);

// –µ—Å–ª–∏ –º–µ—Å—Ç–æ —Å–≤–æ–±–æ–¥–Ω–æ –∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—å
} else if (!occ && !isAdmin) {
    inputCarCode.value = userCarNumber || "";
    inputPhone.value = userPhone || "";
    inputShowPhone.checked = true;
}
// –µ—Å–ª–∏ –º–µ—Å—Ç–æ —Å–≤–æ–±–æ–¥–Ω–æ –∏ —ç—Ç–æ –∞–¥–º–∏–Ω ‚Äî –ø–æ–ª—è –æ—Å—Ç–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–º–∏


                btnSave.style.display = readOnly ? "none" : "inline-block";
                btnSave.disabled = false;
                btnFree.style.display = "none";

                if (occupied && (occupiedByMe || isAdmin)) {
                    btnFree.style.display = "inline-block";
                    btnSave.textContent = occupiedByMe ? "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" : "–ó–∞–Ω—è—Ç—å –º–µ—Å—Ç–æ (–∫–∞–∫ –∞–¥–º–∏–Ω)";
} else if (readOnly) {
    if (modalOwnerNote) {
        modalOwnerNote.textContent = "–ò–∑–º–µ–Ω–∏—Ç—å –º–æ–∂–µ—Ç –≤–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ –∞–¥–º–∏–Ω.";
    }
} else {

                    btnSave.textContent = "–ó–∞–Ω—è—Ç—å –º–µ—Å—Ç–æ";
                }

                modalBackdrop.classList.add("is-open");
            }

            function closeModal() {
    modalBackdrop.classList.remove("is-open");
    currentSpotId = null;
    currentSpotData = null;
	stopUntilCountdown();

    // –ü—Ä—è—á–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    if (btnSubscribe) {
        btnSubscribe.style.display = "none";
    }
}


            function showError(msg) {
                modalError.textContent = msg;
                modalError.classList.add("is-visible");
            }

            function clearError() {
                modalError.textContent = "";
                modalError.classList.remove("is-visible");
            }

            async function fetchSpotsAndRefresh() {
                try {
                    const resp = await fetch("/api/parking/spots");
                    const data = await resp.json();
                    const list = data.spots || [];

                    const indexById = {};
                    list.forEach((s) => { indexById[String(s.id)] = s; });

                    // —Ç–æ—á–∫–∏ –Ω–∞ —Å—Ö–µ–º–µ
document.querySelectorAll(".parking-hotspot").forEach((el) => {
    const sid = el.dataset.spotId;
    const info = indexById[sid];
    if (!info) return;

    const carImg = el.querySelector(".parking-hotspot-car");

    el.dataset.occupied = info.occupied ? "1" : "0";

    el.classList.remove(
        "parking-hotspot--occupied",
        "parking-hotspot--occupied-other",
        "parking-hotspot--long-term"
    );

    if (info.occupied && info.occupant) {
        const occ = info.occupant;
        const mine = occ.apartment === userApartment;

        el.classList.add("parking-hotspot--occupied");
        if (!mine && !isAdmin) {
            el.classList.add("parking-hotspot--occupied-other");
        }

        if (occ.long_term) {
            el.classList.add("parking-hotspot--long-term");
        }

        if (carImg) {
            carImg.style.display = "block";
        }

            let who;
    if (
    occ.is_guest ||
    (occ.apartment && /^g\d+$/i.test(String(occ.apartment))) ||
    (occ.apartment && String(occ.apartment).toLowerCase() === "–≥–æ—Å—Ç—å")
) {

        const guestName = (occ.name || "").trim();
        who = guestName ? `–ì–æ—Å—Ç—å ${guestName}` : "–ì–æ—Å—Ç—å";
    } else if (occ.apartment) {
        who = `–ö–≤. ${occ.apartment}`;
    } else {
        who = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
    }

        const longText = occ.long_term ? " (–Ω–∞–¥–æ–ª–≥–æ)" : "";
        el.title = occ.until
            ? `${who}, ${formatUntilText(occ.until)}${longText}`
            : `–ó–∞–Ω—è—Ç–æ: ${who}${longText}`;
    } else {
        if (carImg) {
            carImg.style.display = "none";
        }
        el.title = "–°–≤–æ–±–æ–¥–Ω–æ";
    }
});


                    // –∫–Ω–æ–ø–∫–∏ –≤ —Å–ø–∏—Å–∫–µ
                    document.querySelectorAll(".parking-spot-btn").forEach((el) => {
                        const sid = el.dataset.spotId;
                        const info = indexById[sid];
                        const statusEl = el.querySelector('[data-role="spot-status"]');
                        if (!statusEl) return;

                        el.classList.remove(
                            "parking-spot-btn--free",
                            "parking-spot-btn--busy",
                            "parking-spot-btn--long"
                        );

                        if (!info || !info.occupied || !info.occupant) {
                            el.classList.add("parking-spot-btn--free");
                            statusEl.textContent = "–ú–æ–∂–Ω–æ –∑–∞–Ω—è—Ç—å";
                            return;
                        }

                        const occ = info.occupant;
                        if (occ.long_term) {
                            el.classList.add("parking-spot-btn--long");
                            statusEl.textContent = "–ù–∞–¥–æ–ª–≥–æ";
                        } else {
                            el.classList.add("parking-spot-btn--busy");
                            statusEl.textContent = formatUntilText(occ.until);
                        }
                    });

                    return indexById;
                } catch (e) {
                    console.error(e);
                }
            }

            function setupClickHandlers() {
                function attach(el) {
                    el.addEventListener("click", async () => {
                        const all = await fetchSpotsAndRefresh();
                        const sid = el.dataset.spotId;
                        const info = all ? all[sid] : null;
                        openModalForSpot(el, info);
                    });
                }

                document.querySelectorAll(".parking-spot-btn").forEach(attach);
                document.querySelectorAll(".parking-hotspot").forEach(attach);
            }

            setupClickHandlers();
			
			            // –§—É–ª–ª—Å–∫—Ä–∏–Ω-–∫–∞—Ä—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            const layout = document.querySelector(".parking-layout");
            const fullscreenBtn = document.getElementById("parkingFullscreenToggle");

            if (layout && fullscreenBtn) {
                fullscreenBtn.addEventListener("click", () => {
                    const active = layout.classList.toggle("parking-layout-fullscreen");
                    fullscreenBtn.classList.toggle("is-active", active);
                    fullscreenBtn.setAttribute("aria-pressed", active ? "true" : "false");
                });
            }

			            // –∑–Ω–∞—á–∫–∏-–ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ —Å—Ö–µ–º–µ
            document.querySelectorAll(".parking-marker").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const msg = btn.dataset.message || "";
                    if (msg) {
                        alert(msg);
                    }
                });
            });
fetchSpotsAndRefresh(); // –ø–µ—Ä–≤–∏—á–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–Ω—è—Ç—ã—Ö –º–µ—Å—Ç

			// --- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∫–æ–≤–∫–∏ (—á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—è–≤–ª—è–ª–æ—Å—å –±–µ–∑ F5) ---
const AUTO_REFRESH_MS = 30000; // 30 —Å–µ–∫—É–Ω–¥
let autoRefreshTimer = null;

function startAutoRefresh() {
    if (autoRefreshTimer) return;
    autoRefreshTimer = setInterval(() => {
        if (document.visibilityState !== "visible") return;
        fetchSpotsAndRefresh();
    }, AUTO_REFRESH_MS);
}

function stopAutoRefresh() {
    if (!autoRefreshTimer) return;
    clearInterval(autoRefreshTimer);
    autoRefreshTimer = null;
}

// –ö–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É ‚Äî —Å—Ä–∞–∑—É –ø–æ–¥—Ç—è–Ω—É—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
        fetchSpotsAndRefresh();
    }
});

window.addEventListener("beforeunload", stopAutoRefresh);

startAutoRefresh();


            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–∞–º "X" –∏ "–û—Ç–º–µ–Ω–∞"
            modalBackdrop.addEventListener("click", (e) => {
                const role = e.target.dataset.role;
                if (role === "close-modal" || role === "cancel-modal") {
                    closeModal();
                }
            });

            // Esc
            window.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && modalBackdrop.classList.contains("is-open")) {
                    closeModal();
                }
            });
// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –º–µ—Å—Ç–æ ‚Äî —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
if (btnSubscribe) {
    btnSubscribe.addEventListener("click", async () => {
        if (!currentSpotId) return;
        clearError();
        btnSubscribe.disabled = true;

        try {
            const resp = await fetch(`/api/parking/spot/${currentSpotId}/subscribe`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Requested-With": "XMLHttpRequest",
                },
                body: JSON.stringify({}),
            });

            let data = {};
            try {
                data = await resp.json();
            } catch (_) {
                data = {};
            }

            if (!resp.ok || !data.ok) {
                const code = data.error || "unknown";

                if (code === "no_telegram_chat_id") {
                    showError(
                        "–ù–µ–ª—å–∑—è –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É: –≤ –ø—Ä–æ—Ñ–∏–ª–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω Telegram. " +
                        "–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∏ —É–∫–∞–∂–∏—Ç–µ telegram_chat_id."
                    );
                } else if (code === "no_user" || code === "no_user_record") {
                    showError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ.");
                } else if (code === "unknown_spot") {
                    showError("–≠—Ç–æ –ø–∞—Ä–∫–æ–≤–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.");
                } else {
                    showError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
                }
                return;
            }

            if (data.already) {
                showError("–í—ã —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ —ç—Ç–æ–º—É –º–µ—Å—Ç—É.");
            } else {
                alert("–ì–æ—Ç–æ–≤–æ! –í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –ö–æ–≥–¥–∞ –º–µ—Å—Ç–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è, –±–æ—Ç –ø—Ä–∏—à–ª—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ.");
            }
        } catch (e) {
            console.error(e);
            showError("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏.");
        } finally {
            btnSubscribe.disabled = false;
        }
    });
}


            btnSave.addEventListener("click", async () => {
                if (!currentSpotId) return;
                clearError();

                const untilVal = inputUntil.value ? inputUntil.value : "";
                const phoneVal = inputPhone.value.trim();
                const carCodeVal = inputCarCode.value.trim();
                const showPhoneVal = inputShowPhone.checked;
                const longTermVal = inputLongTerm.checked;

                try {
                    const resp = await fetch(`/api/parking/spot/${currentSpotId}/occupy`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            until: untilVal || "",
                            phone: phoneVal,
                            car_code: carCodeVal,
                            show_phone: showPhoneVal,
                            long_term: longTermVal
                        })
                    });
                    const data = await resp.json();
                    if (!resp.ok || !data.ok) {
                        const err = data.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏";

                        if (err === "spot_busy") {
                            showError("–≠—Ç–æ –º–µ—Å—Ç–æ —Å–µ–π—á–∞—Å –∑–∞–Ω—è—Ç–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.");
                        } else if (err === "bad_until") {
                            showError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
                        } else if (err === "already_has_spot") {
                            const otherId = data.current_spot_id;
                            if (otherId) {
                                showError(`–£ –≤–∞—Å —É–∂–µ –∑–∞–Ω—è—Ç–æ –º–µ—Å—Ç–æ ${otherId}. –°–Ω–∞—á–∞–ª–∞ –æ—Å–≤–æ–±–æ–¥–∏—Ç–µ –µ–≥–æ, –∑–∞—Ç–µ–º –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–Ω—è—Ç—å –¥—Ä—É–≥–æ–µ.`);
                            } else {
                                showError("–£ –≤–∞—Å —É–∂–µ –∑–∞–Ω—è—Ç–æ –æ–¥–Ω–æ –º–µ—Å—Ç–æ. –°–Ω–∞—á–∞–ª–∞ –æ—Å–≤–æ–±–æ–¥–∏—Ç–µ –µ–≥–æ, –∑–∞—Ç–µ–º –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–Ω—è—Ç—å –¥—Ä—É–≥–æ–µ.");
                            }
                        } else {
                            showError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
                        }
                        return;
                    }
                    await fetchSpotsAndRefresh();
                    closeModal();
                } catch (e) {
                    console.error(e);
                    showError("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
                }
            });

            btnFree.addEventListener("click", async () => {
                if (!currentSpotId) return;
                clearError();
                try {
                    const resp = await fetch(`/api/parking/spot/${currentSpotId}/free`, {
                        method: "POST"
                    });
                    const data = await resp.json();
                    if (!resp.ok || !data.ok) {
                        showError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ.");
                        return;
                    }
                    await fetchSpotsAndRefresh();
                    closeModal();
                } catch (e) {
                    console.error(e);
                    showError("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
                }
            });
        });
    </script>
</section>
{% endblock %}
